'use strict';window.DOMHandler=class{constructor(g,a){this._iRuntime=g;this._componentId=a;this._hasTickCallback=!1;this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(g,a,b,d){this._iRuntime.PostToRuntimeComponent(this._componentId,g,a,b,d)}PostToRuntimeAsync(g,a,b,d){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,g,a,b,d)}_PostToRuntimeMaybeSync(g,a,b){this._iRuntime.UsesWorker()?this.PostToRuntime(g,a,b):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",
component:this._componentId,handler:g,dispatchOpts:b||null,data:a,responseId:null})}AddRuntimeMessageHandler(g,a){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,g,a)}AddRuntimeMessageHandlers(g){for(const [a,b]of g)this.AddRuntimeMessageHandler(a,b)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&
(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}};
window.RateLimiter=class{constructor(g,a){this._callback=g;this._interval=a;this._timerId=-1;this._lastCallTime=-Infinity;this._timerCallFunc=()=>this._OnTimer();this._canRunImmediate=this._ignoreReset=!1}SetCanRunImmediate(g){this._canRunImmediate=!!g}Call(){if(-1===this._timerId){var g=Date.now(),a=g-this._lastCallTime,b=this._interval;a>=b&&this._canRunImmediate?(this._lastCallTime=g,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(b-a,4))}}_RunCallback(){this._ignoreReset=
!0;this._callback();this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1;this._lastCallTime=Date.now();this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer();this._timerCallFunc=this._callback=null}};"use strict";
window.DOMElementHandler=class extends self.DOMHandler{constructor(g,a){super(g,a);this._elementMap=new Map;this._autoAttach=!0;this.AddRuntimeMessageHandlers([["create",b=>this._OnCreate(b)],["destroy",b=>this._OnDestroy(b)],["set-visible",b=>this._OnSetVisible(b)],["update-position",b=>this._OnUpdatePosition(b)],["update-state",b=>this._OnUpdateState(b)],["focus",b=>this._OnSetFocus(b)],["set-css-style",b=>this._OnSetCssStyle(b)],["set-attribute",b=>this._OnSetAttribute(b)],["remove-attribute",
b=>this._OnRemoveAttribute(b)]]);this.AddDOMElementMessageHandler("get-element",b=>b)}SetAutoAttach(g){this._autoAttach=!!g}AddDOMElementMessageHandler(g,a){this.AddRuntimeMessageHandler(g,b=>{const d=this._elementMap.get(b.elementId);return a(d,b)})}_OnCreate(g){const a=g.elementId,b=this.CreateElement(a,g);this._elementMap.set(a,b);b.style.boxSizing="border-box";g.isVisible||(b.style.display="none");g=this._GetFocusElement(b);g.addEventListener("focus",d=>this._OnFocus(a));g.addEventListener("blur",
d=>this._OnBlur(a));this._autoAttach&&document.body.appendChild(b)}CreateElement(g,a){throw Error("required override");}DestroyElement(g){}_OnDestroy(g){g=g.elementId;const a=this._elementMap.get(g);this.DestroyElement(a);this._autoAttach&&a.parentElement.removeChild(a);this._elementMap.delete(g)}PostToRuntimeElement(g,a,b){b||(b={});b.elementId=a;this.PostToRuntime(g,b)}_PostToRuntimeElementMaybeSync(g,a,b){b||(b={});b.elementId=a;this._PostToRuntimeMaybeSync(g,b)}_OnSetVisible(g){this._autoAttach&&
(this._elementMap.get(g.elementId).style.display=g.isVisible?"":"none")}_OnUpdatePosition(g){if(this._autoAttach){var a=this._elementMap.get(g.elementId);a.style.left=g.left+"px";a.style.top=g.top+"px";a.style.width=g.width+"px";a.style.height=g.height+"px";g=g.fontSize;null!==g&&(a.style.fontSize=g+"em")}}_OnUpdateState(g){const a=this._elementMap.get(g.elementId);this.UpdateState(a,g)}UpdateState(g,a){throw Error("required override");}_GetFocusElement(g){return g}_OnFocus(g){this.PostToRuntimeElement("elem-focused",
g)}_OnBlur(g){this.PostToRuntimeElement("elem-blurred",g)}_OnSetFocus(g){const a=this._GetFocusElement(this._elementMap.get(g.elementId));g.focus?a.focus():a.blur()}_OnSetCssStyle(g){this._elementMap.get(g.elementId).style[g.prop]=g.val}_OnSetAttribute(g){this._elementMap.get(g.elementId).setAttribute(g.name,g.val)}_OnRemoveAttribute(g){this._elementMap.get(g.elementId).removeAttribute(g.name)}GetElementById(g){return this._elementMap.get(g)}};"use strict";
{const g=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),a=/android/i.test(navigator.userAgent);let b=0;function d(m){const f=document.createElement("script");f.async=!1;f.type="module";return m.isStringSrc?new Promise(q=>{const u="c3_resolve_"+b;++b;self[u]=q;f.textContent=m.str+`\n\nself["${u}"]();`;document.head.appendChild(f)}):new Promise((q,u)=>{f.onload=q;f.onerror=u;f.src=m;document.head.appendChild(f)})}let l=!1,w=!1;function y(){if(!l){try{new Worker("blob://",{get type(){w=
!0}})}catch(m){}l=!0}return w}let n=new Audio;const r={"audio/webm; codecs=opus":!!n.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!n.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!n.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!n.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!n.canPlayType("audio/mp4"),"audio/mpeg":!!n.canPlayType("audio/mpeg")};n=null;async function c(m){m=await e(m);return(new TextDecoder("utf-8")).decode(m)}
function e(m){return new Promise((f,q)=>{const u=new FileReader;u.onload=z=>f(z.target.result);u.onerror=z=>q(z);u.readAsArrayBuffer(m)})}const p=[];let x=0;window.RealFile=window.File;const k=[],t=new Map,v=new Map;let A=0;const B=[];self.runOnStartup=function(m){if("function"!==typeof m)throw Error("runOnStartup called without a function");B.push(m)};const F=new Set(["cordova","playable-ad","instant-games"]);function H(m){return F.has(m)}let h=!1;window.RuntimeInterface=class m{constructor(f){this._useWorker=
f.useWorker;this._messageChannelPort=null;this._runtimeBaseUrl="";this._scriptFolder=f.scriptFolder;this._workerScriptURLs={};this._localRuntime=this._worker=null;this._domHandlers=[];this._canvas=this._runtimeDomHandler=null;this._isExportingToVideo=!1;this._exportToVideoDuration=0;this._jobScheduler=null;this._rafId=-1;this._rafFunc=()=>this._OnRAFCallback();this._rafCallbacks=[];this._exportType=f.exportType;this._isFileProtocol="file"===location.protocol.substr(0,4);!this._useWorker||"undefined"!==
typeof OffscreenCanvas&&navigator.userActivation&&y()||(this._useWorker=!1);if("playable-ad"===this._exportType||"instant-games"===this._exportType)this._useWorker=!1;if("cordova"===this._exportType&&this._useWorker)if(a){const q=/Chrome\/(\d+)/i.exec(navigator.userAgent);q&&90<=parseInt(q[1],10)||(this._useWorker=!1)}else this._useWorker=!1;this._localFileStrings=this._localFileBlobs=null;"html5"!==this._exportType&&"playable-ad"!==this._exportType||!this._isFileProtocol||alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)");
"html5"!==this._exportType||window.isSecureContext||console.warn("[Construct 3] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available.");this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",q=>this._OnCordovaFetchLocalFile(q));this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",q=>this._OnCreateJobWorker(q));"cordova"===this._exportType?document.addEventListener("deviceready",
()=>this._Init(f)):this._Init(f)}Release(){this._CancelAnimationFrame();this._messageChannelPort&&(this._messageChannelPort=this._messageChannelPort.onmessage=null);this._worker&&(this._worker.terminate(),this._worker=null);this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return g&&
"cordova"===this._exportType}IsiOSWebView(){const f=navigator.userAgent;return g&&H(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(f)}IsAndroid(){return a}IsAndroidWebView(){return a&&H(this._exportType)}async _Init(f){"macos-wkwebview"===this._exportType&&this._SendWrapperMessage({type:"ready"});if("playable-ad"===this._exportType){this._localFileBlobs=self.c3_base64files;this._localFileStrings={};await this._ConvertDataUrisToBlobs();for(let u=0,z=f.engineScripts.length;u<
z;++u){var q=f.engineScripts[u].toLowerCase();this._localFileStrings.hasOwnProperty(q)?f.engineScripts[u]={isStringSrc:!0,str:this._localFileStrings[q]}:this._localFileBlobs.hasOwnProperty(q)&&(f.engineScripts[u]=URL.createObjectURL(this._localFileBlobs[q]))}}f.runtimeBaseUrl?this._runtimeBaseUrl=f.runtimeBaseUrl:(q=location.origin,this._runtimeBaseUrl=("null"===q?"file:///":q)+location.pathname,q=this._runtimeBaseUrl.lastIndexOf("/"),-1!==q&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,q+
1)));f.workerScripts&&(this._workerScriptURLs=f.workerScripts);q=new MessageChannel;this._messageChannelPort=q.port1;this._messageChannelPort.onmessage=u=>this._OnMessageFromRuntime(u.data);window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(u=>this._OnMessageFromDebugger(u));this._jobScheduler=new self.JobSchedulerDOM(this);await this._jobScheduler.Init();"object"===typeof window.StatusBar&&window.StatusBar.hide();if("object"===typeof window.AndroidFullScreen)try{await new Promise((u,
z)=>{window.AndroidFullScreen.immersiveMode(u,z)})}catch(u){console.error("Failed to enter Android immersive mode: ",u)}this._useWorker?await this._InitWorker(f,q.port2):await this._InitDOM(f,q.port2)}_GetWorkerURL(f){f=this._workerScriptURLs.hasOwnProperty(f)?this._workerScriptURLs[f]:f.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?this._workerScriptURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(f.toLowerCase())?this._localFileBlobs[f.toLowerCase()]:
f;f instanceof Blob&&(f=URL.createObjectURL(f));return f}async CreateWorker(f,q,u){if(f.startsWith("blob:"))return new Worker(f,u);if("cordova"===this._exportType&&this._isFileProtocol)return f=await this.CordovaFetchLocalFileAsArrayBuffer(u.isC3MainWorker?f:this._scriptFolder+f),f=new Blob([f],{type:"application/javascript"}),new Worker(URL.createObjectURL(f),u);f=new URL(f,q);if(location.origin!==f.origin){f=await fetch(f);if(!f.ok)throw Error("failed to fetch worker script");f=await f.blob();return new Worker(URL.createObjectURL(f),
u)}return new Worker(f,u)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_GetCommonRuntimeOptions(f){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),devicePixelRatio:window.devicePixelRatio,isFullscreen:m.IsDocumentFullscreen(),projectData:f.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,
previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:f.exportType,isDebug:(new URLSearchParams(self.location.search)).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:r,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,
isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isFBInstantAvailable:"undefined"!==typeof self.FBInstant}}async _InitWorker(f,q){var u=this._GetWorkerURL(f.workerMainUrl);this._worker=await this.CreateWorker(u,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0});this._canvas=document.createElement("canvas");this._canvas.style.display="none";u=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas);window.c3canvas=this._canvas;self.C3_InsertHTMLPlaceholders&&
self.C3_InsertHTMLPlaceholders();let z=f.workerDependencyScripts||[],D=f.engineScripts;z=await Promise.all(z.map(C=>this._MaybeGetCordovaScriptURL(C)));D=await Promise.all(D.map(C=>this._MaybeGetCordovaScriptURL(C)));if("cordova"===this._exportType)for(let C=0,E=f.projectScripts.length;C<E;++C){const G=f.projectScripts[C],I=G[0];if(I===f.mainProjectScript||"scriptsInEvents.js"===I||I.endsWith("/scriptsInEvents.js"))G[1]=await this._MaybeGetCordovaScriptURL(I)}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(f),
{type:"init-runtime",isInWorker:!0,messagePort:q,canvas:u,workerDependencyScripts:z,engineScripts:D,projectScripts:f.projectScripts,mainProjectScript:f.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[q,u,...this._jobScheduler.GetPortTransferables()]);this._domHandlers=k.map(C=>new C(this));this._FindRuntimeDOMHandler();self.c3_callFunction=(C,E)=>this._runtimeDomHandler._InvokeFunctionFromJS(C,E);"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime",
"go-to-last-error-script"))}async _InitDOM(f,q){this._canvas=document.createElement("canvas");this._canvas.style.display="none";document.body.appendChild(this._canvas);window.c3canvas=this._canvas;self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();this._domHandlers=k.map(C=>new C(this));this._FindRuntimeDOMHandler();var u=f.engineScripts.map(C=>"string"===typeof C?(new URL(C,this._runtimeBaseUrl)).toString():C);Array.isArray(f.workerDependencyScripts)&&u.unshift(...f.workerDependencyScripts);
u=await Promise.all(u.map(C=>this._MaybeGetCordovaScriptURL(C)));await Promise.all(u.map(C=>d(C)));u=self.C3_ProjectScriptsStatus;const z=f.mainProjectScript,D=f.projectScripts;for(let [C,E]of D)if(E||(E=C),C===z)try{E=await this._MaybeGetCordovaScriptURL(E),await d(E),"preview"!==this._exportType||u[C]||this._ReportProjectMainScriptError(C,"main script did not run to completion")}catch(G){this._ReportProjectMainScriptError(C,G)}else if("scriptsInEvents.js"===C||C.endsWith("/scriptsInEvents.js"))E=
await this._MaybeGetCordovaScriptURL(E),await d(E);"preview"===this._exportType&&"object"!==typeof self.C3.ScriptsInEvents?(this._RemoveLoadingMessage(),console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")):(f=Object.assign(this._GetCommonRuntimeOptions(f),{isInWorker:!1,messagePort:q,canvas:this._canvas,runOnStartupFunctions:B}),
this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(f),await self.C3_InitRuntime(this._localRuntime,f))}_ReportProjectMainScriptError(f,q){this._RemoveLoadingMessage();console.error(`[Preview] Failed to load project main script (${f}): `,q);alert(`Failed to load project main script (${f}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const f=window.cr_previewLoadingElem;
f&&(f.parentElement.removeChild(f),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(f){f=await this._jobScheduler._CreateJobWorker();return{outputPort:f,transferables:[f]}}_GetLocalRuntime(){if(this._useWorker)throw Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(f,q,u,z,D){this._messageChannelPort.postMessage({type:"event",component:f,handler:q,dispatchOpts:z||null,data:u,responseId:null},D)}PostToRuntimeComponentAsync(f,q,u,z,D){const C=A++,E=new Promise((G,
I)=>{v.set(C,{resolve:G,reject:I})});this._messageChannelPort.postMessage({type:"event",component:f,handler:q,dispatchOpts:z||null,data:u,responseId:C},D);return E}["_OnMessageFromRuntime"](f){const q=f.type;if("event"===q)return this._OnEventFromRuntime(f);if("result"===q)this._OnResultFromRuntime(f);else if("runtime-ready"===q)this._OnRuntimeReady();else if("alert-error"===q)this._RemoveLoadingMessage(),alert(f.message);else if("creating-runtime"===q)this._OnBeforeCreateRuntime();else throw Error(`unknown message '${q}'`);
}_OnEventFromRuntime(f){const q=f.component,u=f.handler,z=f.data,D=f.responseId;if(f=t.get(q))if(f=f.get(u)){var C=null;try{C=f(z)}catch(E){console.error(`Exception in '${q}' handler '${u}':`,E);null!==D&&this._PostResultToRuntime(D,!1,""+E);return}if(null===D)return C;C&&C.then?C.then(E=>this._PostResultToRuntime(D,!0,E)).catch(E=>{console.error(`Rejection from '${q}' handler '${u}':`,E);this._PostResultToRuntime(D,!1,""+E)}):this._PostResultToRuntime(D,!0,C)}else console.warn(`[DOM] No handler '${u}' for component '${q}'`);
else console.warn(`[DOM] No event handlers for component '${q}'`)}_PostResultToRuntime(f,q,u){let z;u&&u.transferables&&(z=u.transferables);this._messageChannelPort.postMessage({type:"result",responseId:f,isOk:q,result:u},z)}_OnResultFromRuntime(f){const q=f.responseId,u=f.isOk;f=f.result;const z=v.get(q);u?z.resolve(f):z.reject(f);v.delete(q)}AddRuntimeComponentMessageHandler(f,q,u){let z=t.get(f);z||(z=new Map,t.set(f,z));if(z.has(q))throw Error(`[DOM] Component '${f}' already has handler '${q}'`);
z.set(q,u)}static AddDOMHandlerClass(f){if(k.includes(f))throw Error("DOM handler already added");k.push(f)}_FindRuntimeDOMHandler(){for(const f of this._domHandlers)if("runtime"===f.GetComponentID()){this._runtimeDomHandler=f;return}throw Error("cannot find runtime DOM handler");}_OnMessageFromDebugger(f){this.PostToRuntimeComponent("debugger","message",f)}_OnRuntimeReady(){for(const f of this._domHandlers)f.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||
document.mozFullScreenElement||h)}static _SetWrapperIsFullscreenFlag(f){h=!!f}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(f){this._rafCallbacks.push(f);this._RequestAnimationFrame()}_RemoveRAFCallback(f){f=this._rafCallbacks.indexOf(f);if(-1===f)throw Error("invalid callback");this._rafCallbacks.splice(f,1);this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&
this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const f of this._rafCallbacks)f();this._RequestAnimationFrame()}TryPlayMedia(f){this._runtimeDomHandler.TryPlayMedia(f)}RemovePendingPlay(f){this._runtimeDomHandler.RemovePendingPlay(f)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(f){this._runtimeDomHandler.SetSilent(f)}IsAudioFormatSupported(f){return!!r[f]}async _WasmDecodeWebMOpus(f){f=
await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:f},null,[f]);return new Float32Array(f)}SetIsExportingToVideo(f){this._isExportingToVideo=!0;this._exportToVideoDuration=f}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(f){return/^(?:[a-z\-]+:)?\/\//.test(f)||"data:"===f.substr(0,5)||"blob:"===f.substr(0,5)}IsRelativeURL(f){return!this.IsAbsoluteURL(f)}async _MaybeGetCordovaScriptURL(f){return"cordova"===
this._exportType&&(f.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(f))?(f.startsWith(this._runtimeBaseUrl)&&(f=f.substr(this._runtimeBaseUrl.length)),f=await this.CordovaFetchLocalFileAsArrayBuffer(f),f=new Blob([f],{type:"application/javascript"}),URL.createObjectURL(f)):f}async _OnCordovaFetchLocalFile(f){const q=f.filename;switch(f.as){case "text":return await this.CordovaFetchLocalFileAsText(q);case "buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(q);default:throw Error("unsupported type");
}}_GetPermissionAPI(){const f=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if("object"!==typeof f)throw Error("Permission API is not loaded");return f}_MapPermissionID(f,q){f=f[q];if("string"!==typeof f)throw Error("Invalid permission name");return f}_HasPermission(f){const q=this._GetPermissionAPI();return new Promise((u,z)=>q.checkPermission(this._MapPermissionID(q,f),D=>u(!!D.hasPermission),z))}_RequestPermission(f){const q=this._GetPermissionAPI();return new Promise((u,
z)=>q.requestPermission(this._MapPermissionID(q,f),D=>u(!!D.hasPermission),z))}async RequestPermissions(f){if("cordova"!==this.GetExportType()||this.IsiOSCordova())return!0;for(const q of f)if(!await this._HasPermission(q)&&!1===await this._RequestPermission(q))return!1;return!0}async RequirePermissions(...f){if(!1===await this.RequestPermissions(f))throw Error("Permission not granted");}CordovaFetchLocalFile(f){const q=window.cordova.file.applicationDirectory+"www/"+f.toLowerCase();return new Promise((u,
z)=>{window.resolveLocalFileSystemURL(q,D=>{D.file(u,z)},z)})}async CordovaFetchLocalFileAsText(f){f=await this.CordovaFetchLocalFile(f);return await c(f)}_CordovaMaybeStartNextArrayBufferRead(){if(p.length&&!(8<=x)){x++;var f=p.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(f.filename,f.successCallback,f.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(f){return new Promise((q,u)=>{p.push({filename:f,successCallback:z=>{x--;this._CordovaMaybeStartNextArrayBufferRead();q(z)},errorCallback:z=>
{x--;this._CordovaMaybeStartNextArrayBufferRead();u(z)}});this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(f,q,u){try{const z=await this.CordovaFetchLocalFile(f),D=await e(z);q(D)}catch(z){u(z)}}_SendWrapperMessage(f){if("windows-webview2"===this._exportType)window.chrome.webview.postMessage(JSON.stringify(f));else if("macos-wkwebview"===this._exportType)window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(f));else throw Error("cannot send wrapper message");
}async _ConvertDataUrisToBlobs(){const f=[];for(const [q,u]of Object.entries(this._localFileBlobs))f.push(this._ConvertDataUriToBlobs(q,u));await Promise.all(f)}async _ConvertDataUriToBlobs(f,q){if("object"===typeof q)this._localFileBlobs[f]=new Blob([q.str],{type:q.type}),this._localFileStrings[f]=q.str;else{let u=await this._FetchDataUri(q);u||(u=this._DataURIToBinaryBlobSync(q));this._localFileBlobs[f]=u}}async _FetchDataUri(f){try{return await (await fetch(f)).blob()}catch(q){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",
q),null}}_DataURIToBinaryBlobSync(f){f=this._ParseDataURI(f);return this._BinaryStringToBlob(f.data,f.mime_type)}_ParseDataURI(f){var q=f.indexOf(",");if(0>q)throw new URIError("expected comma in data: uri");var u=f.substring(5,q);f=f.substring(q+1);q=u.split(";");u=q[0]||"";const z=q[2];f="base64"===q[1]||"base64"===z?atob(f):decodeURIComponent(f);return{mime_type:u,data:f}}_BinaryStringToBlob(f,q){var u=f.length;let z=u>>2,D=new Uint8Array(u),C=new Uint32Array(D.buffer,0,z),E,G;for(G=E=0;E<z;++E)C[E]=
f.charCodeAt(G++)|f.charCodeAt(G++)<<8|f.charCodeAt(G++)<<16|f.charCodeAt(G++)<<24;for(u&=3;u--;)D[G]=f.charCodeAt(G),++G;return new Blob([D],{type:q})}}}"use strict";
{const g=self.RuntimeInterface;function a(h){return h.sourceCapabilities&&h.sourceCapabilities.firesTouchEvents||h.originalEvent&&h.originalEvent.sourceCapabilities&&h.originalEvent.sourceCapabilities.firesTouchEvents}const b=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),d={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},l={dispatchUserScriptEvent:!0},w={dispatchRuntimeEvent:!0};function y(h){return new Promise((m,f)=>{const q=document.createElement("link");q.onload=()=>m(q);q.onerror=
u=>f(u);q.rel="stylesheet";q.href=h;document.head.appendChild(q)})}function n(h){return new Promise((m,f)=>{const q=new Image;q.onload=()=>m(q);q.onerror=u=>f(u);q.src=h})}async function r(h){h=URL.createObjectURL(h);try{return await n(h)}finally{URL.revokeObjectURL(h)}}function c(h){return new Promise((m,f)=>{let q=new FileReader;q.onload=u=>m(u.target.result);q.onerror=u=>f(u);q.readAsText(h)})}async function e(h,m,f){if(!/firefox/i.test(navigator.userAgent))return await r(h);var q=await c(h);q=
(new DOMParser).parseFromString(q,"image/svg+xml");const u=q.documentElement;if(u.hasAttribute("width")&&u.hasAttribute("height")){const z=u.getAttribute("width"),D=u.getAttribute("height");if(!z.includes("%")&&!D.includes("%"))return await r(h)}u.setAttribute("width",m+"px");u.setAttribute("height",f+"px");q=(new XMLSerializer).serializeToString(q);h=new Blob([q],{type:"image/svg+xml"});return await r(h)}function p(h){do{if(h.parentNode&&h.hasAttribute("contenteditable"))return!0;h=h.parentNode}while(h);
return!1}const x=new Set(["input","textarea","datalist","select"]);function k(h){return x.has(h.tagName.toLowerCase())||p(h)}const t=new Set(["canvas","body","html"]);function v(h){const m=h.target.tagName.toLowerCase();t.has(m)&&h.preventDefault()}function A(h){(h.metaKey||h.ctrlKey)&&h.preventDefault()}self.C3_GetSvgImageSize=async function(h){h=await r(h);if(0<h.width&&0<h.height)return[h.width,h.height];{h.style.position="absolute";h.style.left="0px";h.style.top="0px";h.style.visibility="hidden";
document.body.appendChild(h);const m=h.getBoundingClientRect();document.body.removeChild(h);return[m.width,m.height]}};self.C3_RasterSvgImageBlob=async function(h,m,f,q,u){h=await e(h,m,f);const z=document.createElement("canvas");z.width=q;z.height=u;z.getContext("2d").drawImage(h,0,0,m,f);return z};let B=!1;document.addEventListener("pause",()=>B=!0);document.addEventListener("resume",()=>B=!1);function F(){try{return window.parent&&window.parent.document.hasFocus()}catch(h){return!1}}function H(){const h=
document.activeElement;if(!h)return!1;const m=h.tagName.toLowerCase(),f=new Set("email number password search tel text url".split(" "));return"textarea"===m?!0:"input"===m?f.has(h.type.toLowerCase()||"text"):p(h)}g.AddDOMHandlerClass(class extends self.DOMHandler{constructor(h){super(h,"runtime");this._isFirstSizeUpdate=!0;this._simulatedResizeTimerId=-1;this._targetOrientation="any";this._attachedDeviceMotionEvent=this._attachedDeviceOrientationEvent=!1;this._debugHighlightElem=null;this._isExportToVideo=
!1;this._exportVideoProgressMessage="";this._exportVideoUpdateTimerId=-1;this._lastPointerRawUpdateEvent=this._pointerRawUpdateRateLimiter=null;this._pointerRawMovementY=this._pointerRawMovementX=0;this._enableAndroidVKDetection=!1;this._lastWindowWidth=h._GetWindowInnerWidth();this._lastWindowHeight=h._GetWindowInnerHeight();this._virtualKeyboardHeight=0;h.AddRuntimeComponentMessageHandler("canvas","update-size",q=>this._OnUpdateCanvasSize(q));h.AddRuntimeComponentMessageHandler("runtime","invoke-download",
q=>this._OnInvokeDownload(q));h.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",q=>this._OnRasterSvgImage(q));h.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",q=>this._OnGetSvgImageSize(q));h.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",q=>this._OnSetTargetOrientation(q));h.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW());h.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",q=>this._OnPostToDebugger(q));
h.AddRuntimeComponentMessageHandler("runtime","go-to-script",q=>this._OnPostToDebugger(q));h.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking());h.AddRuntimeComponentMessageHandler("runtime","debug-highlight",q=>this._OnDebugHighlight(q));h.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent());h.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent());
h.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",q=>this._OnAddStylesheet(q));h.AddRuntimeComponentMessageHandler("runtime","alert",q=>this._OnAlert(q));h.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash());h.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",q=>this._SetExportingToVideo(q));h.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",q=>this._OnExportVideoProgress(q));h.AddRuntimeComponentMessageHandler("runtime",
"exported-to-video",q=>this._OnExportedToVideo(q));const m=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",q=>{const u=q.target,z=u.tagName.toLowerCase();m.has(z)||p(u)||q.preventDefault()});const f=h.GetCanvas();window.addEventListener("selectstart",v);window.addEventListener("gesturehold",v);f.addEventListener("selectstart",v);f.addEventListener("gesturehold",v);window.addEventListener("touchstart",v,{passive:!1});"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",
v,{passive:!1}),f.addEventListener("pointerdown",v)):f.addEventListener("touchstart",v);this._mousePointerLastButtons=0;window.addEventListener("mousedown",q=>{1===q.button&&q.preventDefault()});window.addEventListener("mousewheel",A,{passive:!1});window.addEventListener("wheel",A,{passive:!1});window.addEventListener("resize",()=>this._OnWindowResize());window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange());
window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange());window.addEventListener("fullscreenerror",q=>this._OnFullscreenError(q));window.addEventListener("webkitfullscreenerror",q=>this._OnFullscreenError(q));window.addEventListener("mozfullscreenerror",q=>this._OnFullscreenError(q));if(h.IsiOSWebView())if(window.visualViewport){let q=Infinity;window.visualViewport.addEventListener("resize",()=>{const u=window.visualViewport.height;u>q&&(document.scrollingElement.scrollTop=0);
q=u})}else window.addEventListener("focusout",()=>{H()||(document.scrollingElement.scrollTop=0)});self.C3WrapperOnMessage=q=>this._OnWrapperMessage(q);this._mediaPendingPlay=new Set;this._mediaRemovedPendingPlay=new WeakSet;this._isSilent=!1}_OnBeforeStartTicking(){self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1E3);"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):
document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden));return{isSuspended:!(!document.hidden&&!B)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus"));window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:F()});this._mousePointerLastButtons=0});window.addEventListener("focusin",m=>{k(m.target)&&this._PostRuntimeEvent("keyboard-blur")});window.addEventListener("keydown",m=>this._OnKeyEvent("keydown",
m));window.addEventListener("keyup",m=>this._OnKeyEvent("keyup",m));window.addEventListener("dblclick",m=>this._OnMouseEvent("dblclick",m,d));window.addEventListener("wheel",m=>this._OnMouseWheelEvent("wheel",m));"undefined"!==typeof PointerEvent?(window.addEventListener("pointerdown",m=>{this._HandlePointerDownFocus(m);this._OnPointerEvent("pointerdown",m)}),this._iRuntime.UsesWorker()&&"undefined"!==typeof window.onpointerrawupdate&&self===self.top?(this._pointerRawUpdateRateLimiter=new self.RateLimiter(()=>
this._DoSendPointerRawUpdate(),5),this._pointerRawUpdateRateLimiter.SetCanRunImmediate(!0),window.addEventListener("pointerrawupdate",m=>this._OnPointerRawUpdate(m))):window.addEventListener("pointermove",m=>this._OnPointerEvent("pointermove",m)),window.addEventListener("pointerup",m=>this._OnPointerEvent("pointerup",m)),window.addEventListener("pointercancel",m=>this._OnPointerEvent("pointercancel",m))):(window.addEventListener("mousedown",m=>{this._HandlePointerDownFocus(m);this._OnMouseEventAsPointer("pointerdown",
m)}),window.addEventListener("mousemove",m=>this._OnMouseEventAsPointer("pointermove",m)),window.addEventListener("mouseup",m=>this._OnMouseEventAsPointer("pointerup",m)),window.addEventListener("touchstart",m=>{this._HandlePointerDownFocus(m);this._OnTouchEvent("pointerdown",m)}),window.addEventListener("touchmove",m=>this._OnTouchEvent("pointermove",m)),window.addEventListener("touchend",m=>this._OnTouchEvent("pointerup",m)),window.addEventListener("touchcancel",m=>this._OnTouchEvent("pointercancel",
m)));const h=()=>this._PlayPendingMedia();window.addEventListener("pointerup",h,!0);window.addEventListener("touchend",h,!0);window.addEventListener("click",h,!0);window.addEventListener("keydown",h,!0);window.addEventListener("gamepadconnected",h,!0);this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),
navigator.virtualKeyboard.boundingRect.height)}))}_OnAndroidVirtualKeyboardChange(h,m){document.body.style.transform="";if(0<m){var f=document.activeElement;f&&(f=f.getBoundingClientRect(),h=(f.top+f.bottom)/2-(h-m)/2,h>m&&(h=m),0>h&&(h=0),0<h&&(document.body.style.transform=`translateY(${-h}px)`))}}_PostRuntimeEvent(h,m){this.PostToRuntime(h,m||null,w)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(!this._isExportToVideo){var h=
this._GetWindowInnerWidth(),m=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView()){if(this._enableAndroidVKDetection){if(this._lastWindowWidth===h&&m<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-m;this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);return}0<this._virtualKeyboardHeight&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(m,this._virtualKeyboardHeight))}this._lastWindowWidth=h;this._lastWindowHeight=
m}this._PostRuntimeEvent("window-resize",{innerWidth:h,innerHeight:m,devicePixelRatio:window.devicePixelRatio,isFullscreen:g.IsDocumentFullscreen()});this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(h,m,0))}}_ScheduleSimulatedResize(h,m,f){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId);this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(h,m,f),48)}_OnSimulatedResize(h,
m,f){const q=this._GetWindowInnerWidth(),u=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1;q!=h||u!=m?this._PostRuntimeEvent("window-resize",{innerWidth:q,innerHeight:u,devicePixelRatio:window.devicePixelRatio,isFullscreen:g.IsDocumentFullscreen()}):10>f&&this._ScheduleSimulatedResize(q,u,f+1)}_OnSetTargetOrientation(h){this._targetOrientation=h.targetOrientation}_TrySetTargetOrientation(){const h=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(h).catch(m=>
console.warn("[Construct 3] Failed to lock orientation: ",m));else try{let m=!1;screen.lockOrientation?m=screen.lockOrientation(h):screen.webkitLockOrientation?m=screen.webkitLockOrientation(h):screen.mozLockOrientation?m=screen.mozLockOrientation(h):screen.msLockOrientation&&(m=screen.msLockOrientation(h));m||console.warn("[Construct 3] Failed to lock orientation")}catch(m){console.warn("[Construct 3] Failed to lock orientation: ",m)}}_OnFullscreenChange(){if(!this._isExportToVideo){var h=g.IsDocumentFullscreen();
h&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation();this.PostToRuntime("fullscreenchange",{isFullscreen:h,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}}_OnFullscreenError(h){console.warn("[Construct 3] Fullscreen request failed: ",h);this.PostToRuntime("fullscreenerror",{isFullscreen:g.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(h){h?this._iRuntime._CancelAnimationFrame():
this._iRuntime._RequestAnimationFrame();this.PostToRuntime("visibilitychange",{hidden:h})}_OnKeyEvent(h,m){"Backspace"===m.key&&v(m);if(!this._isExportToVideo){var f=b.get(m.code)||m.code;this._PostToRuntimeMaybeSync(h,{code:f,key:m.key,which:m.which,repeat:m.repeat,altKey:m.altKey,ctrlKey:m.ctrlKey,metaKey:m.metaKey,shiftKey:m.shiftKey,timeStamp:m.timeStamp},d)}}_OnMouseWheelEvent(h,m){this._isExportToVideo||this.PostToRuntime(h,{clientX:m.clientX,clientY:m.clientY,pageX:m.pageX,pageY:m.pageY,deltaX:m.deltaX,
deltaY:m.deltaY,deltaZ:m.deltaZ,deltaMode:m.deltaMode,timeStamp:m.timeStamp},d)}_OnMouseEvent(h,m,f){this._isExportToVideo||a(m)||this._PostToRuntimeMaybeSync(h,{button:m.button,buttons:m.buttons,clientX:m.clientX,clientY:m.clientY,pageX:m.pageX,pageY:m.pageY,movementX:m.movementX||0,movementY:m.movementY||0,timeStamp:m.timeStamp},f)}_OnMouseEventAsPointer(h,m){if(!this._isExportToVideo&&!a(m)){var f=this._mousePointerLastButtons;"pointerdown"===h&&0!==f?h="pointermove":"pointerup"===h&&0!==m.buttons&&
(h="pointermove");this._PostToRuntimeMaybeSync(h,{pointerId:1,pointerType:"mouse",button:m.button,buttons:m.buttons,lastButtons:f,clientX:m.clientX,clientY:m.clientY,pageX:m.pageX,pageY:m.pageY,movementX:m.movementX||0,movementY:m.movementY||0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:m.timeStamp},d);this._mousePointerLastButtons=m.buttons;this._OnMouseEvent(m.type,m,l)}}_OnPointerEvent(h,m){if(!this._isExportToVideo){this._pointerRawUpdateRateLimiter&&"pointermove"!==
h&&this._pointerRawUpdateRateLimiter.Reset();var f=0;"mouse"===m.pointerType&&(f=this._mousePointerLastButtons);this._PostToRuntimeMaybeSync(h,{pointerId:m.pointerId,pointerType:m.pointerType,button:m.button,buttons:m.buttons,lastButtons:f,clientX:m.clientX,clientY:m.clientY,pageX:m.pageX,pageY:m.pageY,movementX:(m.movementX||0)+this._pointerRawMovementX,movementY:(m.movementY||0)+this._pointerRawMovementY,width:m.width||0,height:m.height||0,pressure:m.pressure||0,tangentialPressure:m.tangentialPressure||
0,tiltX:m.tiltX||0,tiltY:m.tiltY||0,twist:m.twist||0,timeStamp:m.timeStamp},d);this._pointerRawMovementY=this._pointerRawMovementX=0;"mouse"===m.pointerType&&(f="mousemove","pointerdown"===h?f="mousedown":"pointerup"===h&&(f="mouseup"),this._OnMouseEvent(f,m,l),this._mousePointerLastButtons=m.buttons)}}_OnPointerRawUpdate(h){this._lastPointerRawUpdateEvent&&(this._pointerRawMovementX+=this._lastPointerRawUpdateEvent.movementX||0,this._pointerRawMovementY+=this._lastPointerRawUpdateEvent.movementY||
0);this._lastPointerRawUpdateEvent=h;this._pointerRawUpdateRateLimiter.Call()}_DoSendPointerRawUpdate(){this._OnPointerEvent("pointermove",this._lastPointerRawUpdateEvent);this._lastPointerRawUpdateEvent=null}_OnTouchEvent(h,m){if(!this._isExportToVideo)for(let f=0,q=m.changedTouches.length;f<q;++f){const u=m.changedTouches[f];this._PostToRuntimeMaybeSync(h,{pointerId:u.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:u.clientX,clientY:u.clientY,pageX:u.pageX,pageY:u.pageY,
movementX:m.movementX||0,movementY:m.movementY||0,width:2*(u.radiusX||u.webkitRadiusX||0),height:2*(u.radiusY||u.webkitRadiusY||0),pressure:u.force||u.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:u.rotationAngle||0,timeStamp:m.timeStamp},d)}}_HandlePointerDownFocus(h){window!==window.top&&window.focus();this._IsElementCanvasOrDocument(h.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(h){return!h||
h===document||h===window||h===document.body||"canvas"===h.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",h=>this._OnDeviceOrientation(h)),window.addEventListener("deviceorientationabsolute",h=>this._OnDeviceOrientationAbsolute(h)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",h=>this._OnDeviceMotion(h)))}_OnDeviceOrientation(h){this._isExportToVideo||
this.PostToRuntime("deviceorientation",{absolute:!!h.absolute,alpha:h.alpha||0,beta:h.beta||0,gamma:h.gamma||0,timeStamp:h.timeStamp,webkitCompassHeading:h.webkitCompassHeading,webkitCompassAccuracy:h.webkitCompassAccuracy},d)}_OnDeviceOrientationAbsolute(h){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!h.absolute,alpha:h.alpha||0,beta:h.beta||0,gamma:h.gamma||0,timeStamp:h.timeStamp},d)}_OnDeviceMotion(h){if(!this._isExportToVideo){var m=null,f=h.acceleration;
f&&(m={x:f.x||0,y:f.y||0,z:f.z||0});f=null;var q=h.accelerationIncludingGravity;q&&(f={x:q.x||0,y:q.y||0,z:q.z||0});q=null;var u=h.rotationRate;u&&(q={alpha:u.alpha||0,beta:u.beta||0,gamma:u.gamma||0});this.PostToRuntime("devicemotion",{acceleration:m,accelerationIncludingGravity:f,rotationRate:q,interval:h.interval,timeStamp:h.timeStamp},d)}}_OnUpdateCanvasSize(h){var m=this.GetRuntimeInterface();m.IsExportingToVideo()||(m=m.GetCanvas(),m.style.width=h.styleWidth+"px",m.style.height=h.styleHeight+
"px",m.style.marginLeft=h.marginLeft+"px",m.style.marginTop=h.marginTop+"px",this._isFirstSizeUpdate&&(m.style.display="",this._isFirstSizeUpdate=!1))}_OnInvokeDownload(h){const m=h.url;h=h.filename;const f=document.createElement("a"),q=document.body;f.textContent=h;f.href=m;f.download=h;q.appendChild(f);f.click();q.removeChild(f)}async _OnRasterSvgImage(h){var m=h.imageBitmapOpts;h=await self.C3_RasterSvgImageBlob(h.blob,h.imageWidth,h.imageHeight,h.surfaceWidth,h.surfaceHeight);m=m?await createImageBitmap(h,
m):await createImageBitmap(h);return{imageBitmap:m,transferables:[m]}}async _OnGetSvgImageSize(h){return await self.C3_GetSvgImageSize(h.blob)}async _OnAddStylesheet(h){await y(h.url)}_PlayPendingMedia(){var h=[...this._mediaPendingPlay];this._mediaPendingPlay.clear();if(!this._isSilent)for(const m of h)(h=m.play())&&h.catch(f=>{this._mediaRemovedPendingPlay.has(m)||this._mediaPendingPlay.add(m)})}TryPlayMedia(h){if("function"!==typeof h.play)throw Error("missing play function");this._mediaRemovedPendingPlay.delete(h);
let m;try{m=h.play()}catch(f){this._mediaPendingPlay.add(h);return}m&&m.catch(f=>{this._mediaRemovedPendingPlay.has(h)||this._mediaPendingPlay.add(h)})}RemovePendingPlay(h){this._mediaPendingPlay.delete(h);this._mediaRemovedPendingPlay.add(h)}SetSilent(h){this._isSilent=!!h}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(h){if(h.show){this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id=
"inspectOutline",document.body.appendChild(this._debugHighlightElem));var m=this._debugHighlightElem;m.style.display="";m.style.left=h.left-1+"px";m.style.top=h.top-1+"px";m.style.width=h.width+2+"px";m.style.height=h.height+2+"px";m.textContent=h.name}else this._debugHighlightElem&&(this._debugHighlightElem.style.display="none")}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(h){window.c3_postToMessagePort&&(h.from="runtime",window.c3_postToMessagePort(h))}_InvokeFunctionFromJS(h,
m){return this.PostToRuntimeAsync("js-invoke-function",{name:h,params:m})}_OnAlert(h){alert(h.message)}_OnWrapperMessage(h){"entered-fullscreen"===h?(g._SetWrapperIsFullscreenFlag(!0),this._OnFullscreenChange()):"exited-fullscreen"===h?(g._SetWrapperIsFullscreenFlag(!1),this._OnFullscreenChange()):console.warn("Unknown wrapper message: ",h)}_SetExportingToVideo(h){this._isExportToVideo=!0;const m=document.createElement("h1");m.id="exportToVideoMessage";m.textContent=h.message;document.body.prepend(m);
document.body.classList.add("exportingToVideo");this.GetRuntimeInterface().GetCanvas().style.display="";this._iRuntime.SetIsExportingToVideo(h.duration)}_OnExportVideoProgress(h){this._exportVideoProgressMessage=h.message;-1===this._exportVideoUpdateTimerId&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const h=document.getElementById("exportToVideoMessage");h&&(h.textContent=
this._exportVideoProgressMessage)}_OnExportedToVideo(h){window.c3_postToMessagePort({type:"exported-video",blob:h.blob,time:h.time})}})}"use strict";
self.JobSchedulerDOM=class{constructor(g){this._runtimeInterface=g;this._baseUrl=g.GetRuntimeBaseURL();"preview"===g.GetExportType()?this._baseUrl+="workers/":this._baseUrl+=g.GetScriptFolder();this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16);this._dispatchWorker=null;this._jobWorkers=[];this._outputPort=this._inputPort=null}async Init(){if(this._hasInitialised)throw Error("already initialised");this._hasInitialised=!0;var g=this._runtimeInterface._GetWorkerURL("dispatchworker.js");
this._dispatchWorker=await this._runtimeInterface.CreateWorker(g,this._baseUrl,{name:"DispatchWorker"});g=new MessageChannel;this._inputPort=g.port1;this._dispatchWorker.postMessage({type:"_init","in-port":g.port2},[g.port2]);this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const g=this._jobWorkers.length;var a=this._runtimeInterface._GetWorkerURL("jobworker.js");a=await this._runtimeInterface.CreateWorker(a,this._baseUrl,{name:"JobWorker"+g});const b=new MessageChannel,d=new MessageChannel;
this._dispatchWorker.postMessage({type:"_addJobWorker",port:b.port1},[b.port1]);a.postMessage({type:"init",number:g,"dispatch-port":b.port2,"output-port":d.port2},[b.port2,d.port2]);this._jobWorkers.push(a);return d.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}};"use strict";
window.C3_IsSupported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!1,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[],mainProjectScript:"",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));"use strict";
{function g(a){return a&&!a.paused&&!a.ended&&0<a.currentTime}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(a){super(a,"video");this.SetAutoAttach(!1);this._postImageBitmaps=this._supportsRvfc=this._isRuntimeInWorker=!1;this._numVideos=this._sequenceNumber=0;this._destroyedVideos=new WeakSet;this.AddRuntimeMessageHandler("init",b=>this._OnInit(b));this.AddDOMElementMessageHandler("play",b=>this._OnPlay(b));this.AddDOMElementMessageHandler("pause",b=>this._OnPause(b));
this.AddDOMElementMessageHandler("set-source",(b,d)=>this._OnSetSource(b,d));this.AddDOMElementMessageHandler("set-playback-time",(b,d)=>this._OnSetPlaybackTime(b,d));this.AddDOMElementMessageHandler("set-playback-rate",(b,d)=>this._OnSetPlaybackRate(b,d));this.AddDOMElementMessageHandler("set-looping",(b,d)=>this._OnSetLooping(b,d));this.AddDOMElementMessageHandler("set-muted",(b,d)=>this._OnSetMuted(b,d));this.AddDOMElementMessageHandler("set-volume",(b,d)=>this._OnSetVolume(b,d));self.C3Video_GetElement=
b=>this.GetElementById(b)}async _OnInit(a){this._isRuntimeInWorker=a.isInWorker;a=document.createElement("video");this._supportsRvfc=!!a.requestVideoFrameCallback&&!this._iRuntime.IsAndroidWebView();const b=!!self.createImageBitmap;this._postImageBitmaps=this._isRuntimeInWorker||b;return{postImageBitmaps:this._postImageBitmaps,supportedFormats:{"video/webm":!!a.canPlayType("video/webm"),"video/ogg":!!a.canPlayType("video/ogg"),"video/mp4":!!a.canPlayType("video/mp4")}}}TryPlayMedia(a){this._iRuntime.TryPlayMedia(a);
this._postImageBitmaps&&this._supportsRvfc&&-1===a.c3_rvfcId&&(a.c3_rvfcId=a.requestVideoFrameCallback(()=>this._OnVideoFrameCallback(a)))}RemovePendingPlay(a){this._iRuntime.RemovePendingPlay(a);this._postImageBitmaps&&this._supportsRvfc&&-1!==a.c3_rvfcId&&(a.cancelVideoFrameCallback(a.c3_rvfcId),a.c3_rvfcId=-1)}async _OnVideoFrameCallback(a){if(!this._destroyedVideos.has(a)){a.c3_rvfcId=a.requestVideoFrameCallback(()=>this._OnVideoFrameCallback(a));try{const b=a.c3_sequenceNumber++,d=await createImageBitmap(a);
b>a.c3_lastFrameSequence&&(a.c3_imageBitmap=d,a.c3_lastFrameSequence=b)}catch(b){}}}CreateElement(a,b){const d=document.createElement("video");d.crossOrigin="anonymous";d.playsInline=!0;d.c3_imageBitmap=null;d.c3_rvfcId=-1;d.c3_sequenceNumber=0;d.c3_lastFrameSequence=-1;d.addEventListener("canplay",()=>this._SendPlaybackEvent(d,a,0));d.addEventListener("canplaythrough",()=>this._SendPlaybackEvent(d,a,1));d.addEventListener("ended",()=>this._SendPlaybackEvent(d,a,2));d.addEventListener("error",()=>
this._SendPlaybackEvent(d,a,3));d.addEventListener("loadstart",()=>this._SendPlaybackEvent(d,a,4));d.addEventListener("playing",()=>this._SendPlaybackEvent(d,a,5));d.addEventListener("pause",()=>this._SendPlaybackEvent(d,a,6));d.addEventListener("stalled",()=>this._SendPlaybackEvent(d,a,7));const l=b.autoplay;0===l?(d.autoplay=!1,d.preload="none"):1===l?(d.autoplay=!1,d.preload="auto"):d.autoplay=!0;b.src&&(d.src=b.src);2===l&&this.TryPlayMedia(d);this._numVideos++;this._StartTicking();return d}_SendPlaybackEvent(a,
b,d){this._destroyedVideos.has(a)||this.PostToRuntimeElement("playback-event",b,{type:d})}UpdateState(a,b){}DestroyElement(a){this.RemovePendingPlay(a);g(a)&&a.pause();a.src="";this._numVideos=Math.max(this._numVideos-1,0);0===this._numVideos&&this._StopTicking();this._destroyedVideos.add(a)}_OnPlay(a){this.TryPlayMedia(a)}_OnPause(a){this.RemovePendingPlay(a);a.pause()}_OnSetSource(a,b){a.src=b.src;a.load()}_OnSetPlaybackTime(a,b){try{a.currentTime=b.time}catch(d){console.error("[Video] Exception setting playback time: ",
d)}}_OnSetPlaybackRate(a,b){try{a.playbackRate=b.rate}catch(d){console.error("[Video] Exception setting playback rate: ",d)}}_OnSetLooping(a,b){a.loop=b.isLooping}_OnSetMuted(a,b){a.muted=b.isMuted}_OnSetVolume(a,b){a.volume=b.volume}Tick(){const a={},b={sequenceNumber:this._sequenceNumber++,videoData:a},d=[],l=[];for(const [w,y]of this._elementMap.entries()){const n={currentTime:y.currentTime,playbackRate:y.playbackRate,duration:y.duration,videoWidth:y.videoWidth,videoHeight:y.videoHeight};if(this._postImageBitmaps)if(this._supportsRvfc){const r=
y.c3_imageBitmap;y.c3_imageBitmap=null;(n.imageBitmap=r)&&d.push(r)}else l.push(createImageBitmap(y).then(r=>{n.imageBitmap=r;d.push(r)}).catch(r=>{n.imageBitmap=null}));a[w.toString()]=n}Promise.all(l).then(()=>{this._isRuntimeInWorker?this.PostToRuntime("state",b,!1,d):this._PostToRuntimeMaybeSync("state",b)})}})}"use strict";
{const g=180/Math.PI;self.AudioDOMHandler=class extends self.DOMHandler{constructor(a){super(a,"audio");this._destinationNode=this._audioContext=null;this._hasAttachedUnblockEvents=this._hasUnblocked=!1;this._unblockFunc=()=>this._UnblockAudioContext();this._audioBuffers=[];this._audioInstances=[];this._lastAudioInstance=null;this._lastPlayedTag="";this._lastTickCount=-1;this._pendingTags=new Map;this._masterVolume=1;this._isSilent=!1;this._timeScaleMode=0;this._timeScale=1;this._gameTime=0;this._panningModel=
"HRTF";this._distanceModel="inverse";this._refDistance=600;this._maxDistance=1E4;this._rolloffFactor=1;this._hasAnySoftwareDecodedMusic=this._playMusicAsSound=!1;this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus");this._effects=new Map;this._analysers=new Set;this._hasStartedOfflineRender=this._isPendingPostFxState=!1;this._microphoneTag="";this._microphoneSource=null;self.C3Audio_OnMicrophoneStream=(b,d)=>this._OnMicrophoneStream(b,d);this._destMediaStreamNode=
null;self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream();self.C3Audio_DOMInterface=this;this.AddRuntimeMessageHandlers([["create-audio-context",b=>this._CreateAudioContext(b)],["play",b=>this._Play(b)],["stop",b=>this._Stop(b)],["stop-all",()=>this._StopAll()],["set-paused",b=>this._SetPaused(b)],["set-volume",b=>this._SetVolume(b)],["fade-volume",b=>this._FadeVolume(b)],["set-master-volume",b=>this._SetMasterVolume(b)],["set-muted",b=>this._SetMuted(b)],["set-silent",b=>this._SetSilent(b)],
["set-looping",b=>this._SetLooping(b)],["set-playback-rate",b=>this._SetPlaybackRate(b)],["seek",b=>this._Seek(b)],["preload",b=>this._Preload(b)],["unload",b=>this._Unload(b)],["unload-all",()=>this._UnloadAll()],["set-suspended",b=>this._SetSuspended(b)],["add-effect",b=>this._AddEffect(b)],["set-effect-param",b=>this._SetEffectParam(b)],["remove-effects",b=>this._RemoveEffects(b)],["tick",b=>this._OnTick(b)],["load-state",b=>this._OnLoadState(b)],["offline-render-audio",b=>this._OnOfflineRenderAudio(b)],
["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(a){a.isiOSCordova&&(this._playMusicAsSound=!0);this._timeScaleMode=a.timeScaleMode;this._panningModel=["equalpower","HRTF","soundfield"][a.panningModel];this._distanceModel=["linear","inverse","exponential"][a.distanceModel];this._refDistance=a.refDistance;this._maxDistance=a.maxDistance;this._rolloffFactor=a.rolloffFactor;if(this._iRuntime.IsExportingToVideo())this._playMusicAsSound=!0,this._audioContext=new OfflineAudioContext({numberOfChannels:2,
sampleRate:48E3,length:Math.ceil(48E3*this._iRuntime.GetExportToVideoDuration())});else{var b={latencyHint:a.latencyHint};this.SupportsWebMOpus()||(b.sampleRate=48E3);if("undefined"!==typeof AudioContext)this._audioContext=new AudioContext(b);else if("undefined"!==typeof webkitAudioContext)this._audioContext=new webkitAudioContext(b);else throw Error("Web Audio API not supported");this._AttachUnblockEvents();this._audioContext.onstatechange=()=>{"running"!==this._audioContext.state&&this._AttachUnblockEvents();
this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})}}this._destinationNode=this._audioContext.createGain();this._destinationNode.connect(this._audioContext.destination);b=a.listenerPos;this._audioContext.listener.setPosition(b[0],b[1],b[2]);this._audioContext.listener.setOrientation(0,0,1,0,-1,0);self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(a.preloadList.map(d=>this._GetAudioBuffer(d.originalUrl,d.url,d.type,!1)))}catch(d){console.error("[Construct 3] Preloading sounds failed: ",
d)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(this._hasUnblocked=!1,window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(this._hasUnblocked=
!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){if(!this._hasUnblocked){var a=this._audioContext;"suspended"===a.state&&a.resume&&a.resume();var b=a.createBuffer(1,220,22050),d=a.createBufferSource();d.buffer=b;d.connect(a.destination);d.start(0);"running"===
a.state&&this._DetachUnblockEvents()}}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetDestinationForTag(a){return(a=this._effects.get(a.toLowerCase()))?a[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(a,b){a=a.toLowerCase();let d=this._effects.get(a);d||(d=[],this._effects.set(a,d));b._SetIndex(d.length);b._SetTag(a);d.push(b);this._ReconnectEffects(a)}_ReconnectEffects(a){let b=
this.GetDestinationNode();const d=this._effects.get(a);if(d&&d.length){b=d[0].GetInputNode();for(let l=0,w=d.length;l<w;++l){const y=d[l];l+1===w?y.ConnectTo(this.GetDestinationNode()):y.ConnectTo(d[l+1].GetInputNode())}}for(const l of this.audioInstancesByTag(a))l.Reconnect(b);this._microphoneSource&&this._microphoneTag===a&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(b))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=
!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(a,b){return b?this._iRuntime._WasmDecodeWebMOpus(a).then(d=>{const l=this._audioContext.createBuffer(1,d.length,48E3);l.getChannelData(0).set(d);return l}):new Promise((d,l)=>{this._audioContext.decodeAudioData(a,d,l)})}TryPlayMedia(a){this._iRuntime.TryPlayMedia(a)}RemovePendingPlay(a){this._iRuntime.RemovePendingPlay(a)}ReleaseInstancesForBuffer(a){let b=
0;for(let d=0,l=this._audioInstances.length;d<l;++d){const w=this._audioInstances[d];this._audioInstances[b]=w;w.GetBuffer()===a?w.Release():++b}this._audioInstances.length=b}ReleaseAllMusicBuffers(){let a=0;for(let b=0,d=this._audioBuffers.length;b<d;++b){const l=this._audioBuffers[b];this._audioBuffers[a]=l;l.IsMusic()?l.Release():++a}this._audioBuffers.length=a}*audioInstancesByTag(a){if(a)for(const b of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(b.GetTag(),a)&&(yield b);else this._lastAudioInstance&&
!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(a,b,d,l,w){for(const y of this._audioBuffers)if(y.GetUrl()===b)return await y.Load(),y;if(w)return null;l&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();a=self.C3AudioBuffer.Create(this,a,b,d,l);this._audioBuffers.push(a);await a.Load();return a}async _GetAudioInstance(a,b,d,l,w){for(const y of this._audioInstances)if(y.GetUrl()===b&&(y.CanBeRecycled()||w))return y.SetTag(l),
y;a=(await this._GetAudioBuffer(a,b,d,w)).CreateInstance(l);this._audioInstances.push(a);return a}_AddPendingTag(a){let b=this._pendingTags.get(a);if(!b){let d=null;b={pendingCount:0,promise:new Promise(l=>d=l),resolve:d};this._pendingTags.set(a,b)}b.pendingCount++}_RemovePendingTag(a){const b=this._pendingTags.get(a);if(!b)throw Error("expected pending tag");b.pendingCount--;0===b.pendingCount&&(b.resolve(),this._pendingTags.delete(a))}TagReady(a){a||(a=this._lastPlayedTag);return(a=this._pendingTags.get(a))?
a.promise:Promise.resolve()}_MaybeStartTicking(){if(0<this._analysers.size)this._StartTicking();else for(const a of this._audioInstances)if(a.IsActive()){this._StartTicking();break}}Tick(){for(var a of this._analysers)a.Tick();a=this.GetAudioCurrentTime();for(var b of this._audioInstances)b.Tick(a);b=this._audioInstances.filter(d=>d.IsActive()).map(d=>d.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,audioInstances:b,analysers:[...this._analysers].map(d=>d.GetData())});0===b.length&&
0===this._analysers.size&&this._StopTicking()}PostTrigger(a,b,d){this.PostToRuntime("trigger",{type:a,tag:b,aiid:d})}async _Play(a){const b=a.originalUrl,d=a.url,l=a.type,w=a.isMusic,y=a.tag,n=a.isLooping,r=a.vol,c=a.pos,e=a.panning;let p=a.off;0<p&&!a.trueClock&&(this._audioContext.getOutputTimestamp?(a=this._audioContext.getOutputTimestamp(),p=p-a.performanceTime/1E3+a.contextTime):p=p-performance.now()/1E3+this._audioContext.currentTime);this._lastPlayedTag=y;this._AddPendingTag(y);try{this._lastAudioInstance=
await this._GetAudioInstance(b,d,l,y,w),e?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(e.x,e.y,e.angle,e.innerAngle,e.outerAngle,e.outerGain),e.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(e.uid)):this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.Play(n,r,c,p)}catch(x){console.error("[Construct 3] Audio: error starting playback: ",x);return}finally{this._RemovePendingTag(y)}this._StartTicking()}_Stop(a){a=a.tag;for(const b of this.audioInstancesByTag(a))b.Stop()}_StopAll(){for(const a of this._audioInstances)a.Stop()}_SetPaused(a){const b=
a.tag;a=a.paused;for(const d of this.audioInstancesByTag(b))a?d.Pause():d.Resume();this._MaybeStartTicking()}_SetVolume(a){const b=a.tag;a=a.vol;for(const d of this.audioInstancesByTag(b))d.SetVolume(a)}async _FadeVolume(a){const b=a.tag,d=a.vol,l=a.duration;a=a.stopOnEnd;await this.TagReady(b);for(const w of this.audioInstancesByTag(b))w.FadeVolume(d,l,a);this._MaybeStartTicking()}_SetMasterVolume(a){this._masterVolume=a.vol;this._destinationNode.gain.value=this._masterVolume}_SetMuted(a){const b=
a.tag;a=a.isMuted;for(const d of this.audioInstancesByTag(b))d.SetMuted(a)}_SetSilent(a){this._isSilent=a.isSilent;this._iRuntime.SetSilent(this._isSilent);for(const b of this._audioInstances)b._UpdateMuted()}_SetLooping(a){const b=a.tag;a=a.isLooping;for(const d of this.audioInstancesByTag(b))d.SetLooping(a)}async _SetPlaybackRate(a){const b=a.tag;a=a.rate;await this.TagReady(b);for(const d of this.audioInstancesByTag(b))d.SetPlaybackRate(a)}async _Seek(a){const b=a.tag;a=a.pos;await this.TagReady(b);
for(const d of this.audioInstancesByTag(b))d.Seek(a)}async _Preload(a){const b=a.originalUrl,d=a.url,l=a.type;a=a.isMusic;try{await this._GetAudioInstance(b,d,l,"",a)}catch(w){console.error("[Construct 3] Audio: error preloading: ",w)}}async _Unload(a){if(a=await this._GetAudioBuffer("",a.url,a.type,a.isMusic,!0))a.Release(),a=this._audioBuffers.indexOf(a),-1!==a&&this._audioBuffers.splice(a,1)}_UnloadAll(){for(const a of this._audioBuffers)a.Release();this._audioBuffers.length=0}_SetSuspended(a){a=
a.isSuspended;!a&&this._audioContext.resume&&this._audioContext.resume();for(const b of this._audioInstances)b.SetSuspended(a);a&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(a){this._timeScale=a.timeScale;this._gameTime=a.gameTime;this._lastTickCount=a.tickCount;if(0!==this._timeScaleMode)for(var b of this._audioInstances)b._UpdatePlaybackRate();(b=a.listenerPos)&&this._audioContext.listener.setPosition(b[0],b[1],b[2]);for(const d of a.instPans){a=d.uid;for(const l of this._audioInstances)l.GetUID()===
a&&l.SetPanXYA(d.x,d.y,d.angle)}}async _AddEffect(a){var b=a.type;const d=a.tag;var l=a.params;if("filter"===b)l=new self.C3AudioFilterFX(this,...l);else if("delay"===b)l=new self.C3AudioDelayFX(this,...l);else if("convolution"===b){b=null;try{b=await this._GetAudioBuffer(a.bufferOriginalUrl,a.bufferUrl,a.bufferType,!1)}catch(w){console.log("[Construct 3] Audio: error loading convolution: ",w);return}l=new self.C3AudioConvolveFX(this,b.GetAudioBuffer(),...l);l._SetBufferInfo(a.bufferOriginalUrl,a.bufferUrl,
a.bufferType)}else if("flanger"===b)l=new self.C3AudioFlangerFX(this,...l);else if("phaser"===b)l=new self.C3AudioPhaserFX(this,...l);else if("gain"===b)l=new self.C3AudioGainFX(this,...l);else if("tremolo"===b)l=new self.C3AudioTremoloFX(this,...l);else if("ringmod"===b)l=new self.C3AudioRingModFX(this,...l);else if("distortion"===b)l=new self.C3AudioDistortionFX(this,...l);else if("compressor"===b)l=new self.C3AudioCompressorFX(this,...l);else if("analyser"===b)l=new self.C3AudioAnalyserFX(this,
...l);else throw Error("invalid effect type");this.AddEffectForTag(d,l);this._PostUpdatedFxState()}_SetEffectParam(a){const b=a.index,d=a.param,l=a.value,w=a.ramp,y=a.time;a=this._effects.get(a.tag);!a||0>b||b>=a.length||(a[b].SetParam(d,l,w,y),this._PostUpdatedFxState())}_RemoveEffects(a){a=a.tag.toLowerCase();const b=this._effects.get(a);if(b&&b.length){for(const d of b)d.Release();this._effects.delete(a);this._ReconnectEffects(a)}}_AddAnalyser(a){this._analysers.add(a);this._MaybeStartTicking()}_RemoveAnalyser(a){this._analysers.delete(a)}_PostUpdatedFxState(){this._isPendingPostFxState||
(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const a={};for(const [b,d]of this._effects)a[b]=d.map(l=>l.GetState());this.PostToRuntime("fxstate",{fxstate:a});this._isPendingPostFxState=!1}async _OnLoadState(a){const b=a.saveLoadMode;if(3!==b)for(var d of this._audioInstances)d.IsMusic()&&1===b||(d.IsMusic()||2!==b)&&d.Stop();for(const l of this._effects.values())for(const w of l)w.Release();this._effects.clear();this._timeScale=a.timeScale;
this._gameTime=a.gameTime;d=a.listenerPos;this._audioContext.listener.setPosition(d[0],d[1],d[2]);this._isSilent=a.isSilent;this._iRuntime.SetSilent(this._isSilent);this._masterVolume=a.masterVolume;this._destinationNode.gain.value=this._masterVolume;d=[];for(const l of Object.values(a.effects))d.push(Promise.all(l.map(w=>this._AddEffect(w))));await Promise.all(d);await Promise.all(a.playing.map(l=>this._LoadAudioInstance(l,b)));this._MaybeStartTicking()}async _LoadAudioInstance(a,b){if(3!==b){var d=
a.bufferOriginalUrl,l=a.bufferUrl,w=a.bufferType,y=a.isMusic,n=a.tag,r=a.isLooping,c=a.volume,e=a.playbackTime;if(!y||1!==b)if(y||2!==b){b=null;try{b=await this._GetAudioInstance(d,l,w,n,y)}catch(p){console.error("[Construct 3] Audio: error loading audio state: ",p);return}b.LoadPanState(a.pan);b.Play(r,c,e,0);a.isPlaying||b.Pause();b._LoadAdditionalState(a)}}}_OnMicrophoneStream(a,b){this._microphoneSource&&this._microphoneSource.disconnect();this._microphoneTag=b.toLowerCase();this._microphoneSource=
this._audioContext.createMediaStreamSource(a);this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode));return this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(a){try{const b=this._audioContext.suspend(a.time);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(d=>
this._OnOfflineRenderCompleted(d)).catch(d=>this._OnOfflineRenderError(d)),this._hasStartedOfflineRender=!0);await b}catch(b){this._OnOfflineRenderError(b)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(a){const b=[];for(let d=0,l=a.numberOfChannels;d<l;++d){const w=a.getChannelData(d);b.push(w.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:a.duration,length:a.length,numberOfChannels:a.numberOfChannels,sampleRate:a.sampleRate,
channelData:b},null,b)}_OnOfflineRenderError(a){console.error("[Audio] Offline rendering error: ",a)}static EqualsNoCase(a,b){return a.length!==b.length?!1:a===b?!0:a.toLowerCase()===b.toLowerCase()}static ToDegrees(a){return a*g}static DbToLinearNoCap(a){return Math.pow(10,a/20)}static DbToLinear(a){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(a),1),0)}static LinearToDbNoCap(a){return Math.log(a)/Math.log(10)*20}static LinearToDb(a){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(a,
1),0))}static e4(a,b){return 1-Math.exp(-b*a)}};self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler)}"use strict";
self.C3AudioBuffer=class{constructor(g,a,b,d,l){this._audioDomHandler=g;this._originalUrl=a;this._url=b;this._type=d;this._isMusic=l;this._api="";this._loadState="not-loaded";this._loadPromise=null}Release(){this._loadState="not-loaded";this._loadPromise=this._audioDomHandler=null}static Create(g,a,b,d,l){const w="audio/webm; codecs=opus"===d&&!g.SupportsWebMOpus();l&&w&&g._SetHasAnySoftwareDecodedMusic();return!l||g.IsPlayMusicAsSound()||w?new self.C3WebAudioBuffer(g,a,b,d,l,w):new self.C3Html5AudioBuffer(g,
a,b,d,l)}CreateInstance(g){return"html5"===this._api?new self.C3Html5AudioInstance(this._audioDomHandler,this,g):new self.C3WebAudioInstance(this._audioDomHandler,this,g)}_Load(){}Load(){this._loadPromise||(this._loadPromise=this._Load());return this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return"failed"===this._loadState}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};
"use strict";
self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(g,a,b,d,l){super(g,a,b,d,l);this._api="html5";this._audioElem=new Audio;this._audioElem.crossOrigin="anonymous";this._audioElem.autoplay=!1;this._audioElem.preload="auto";this._loadReject=this._loadResolve=null;this._reachedCanPlayThrough=!1;this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0);this._outNode=this.GetAudioContext().createGain();this._mediaSourceNode=null;this._audioElem.addEventListener("canplay",()=>
{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadReject=this._loadResolve=null);!this._mediaSourceNode&&this._audioElem&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))});this.onended=null;this._audioElem.addEventListener("ended",()=>{if(this.onended)this.onended()});this._audioElem.addEventListener("error",w=>this._OnError(w))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this);
this._outNode.disconnect();this._outNode=null;this._mediaSourceNode.disconnect();this._mediaSourceNode=null;this._audioElem&&!this._audioElem.paused&&this._audioElem.pause();this._audioElem=this.onended=null;super.Release()}_Load(){this._loadState="loading";return new Promise((g,a)=>{this._loadResolve=g;this._loadReject=a;this._audioElem.src=this._url})}_OnError(g){console.error(`[Construct 3] Audio '${this._url}' error: `,g);this._loadReject&&(this._loadState="failed",this._loadReject(g),this._loadReject=
this._loadResolve=null)}IsLoaded(){const g=4<=this._audioElem.readyState;g&&(this._reachedCanPlayThrough=!0);return g||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}};"use strict";
self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(g,a,b,d,l,w){super(g,a,b,d,l);this._api="webaudio";this._audioBuffer=this._audioData=null;this._needsSoftwareDecode=!!w}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this);this._audioBuffer=this._audioData=null;super.Release()}async _Fetch(){if(this._audioData)return this._audioData;var g=this._audioDomHandler.GetRuntimeInterface();if("cordova"===g.GetExportType()&&g.IsRelativeURL(this._url)&&g.IsFileProtocol())this._audioData=
await g.CordovaFetchLocalFileAsArrayBuffer(this._url);else{g=await fetch(this._url);if(!g.ok)throw Error(`error fetching audio data: ${g.status} ${g.statusText}`);this._audioData=await g.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode);this._audioData=null}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(g){this._loadState=
"failed",console.error(`[Construct 3] Failed to load audio '${this._url}': `,g)}}IsLoaded(){return!(!this._audioData&&!this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};"use strict";
{let g=0;self.C3AudioInstance=class{constructor(a,b,d){this._audioDomHandler=a;this._buffer=b;this._tag=d;this._aiId=g++;this._gainNode=this.GetAudioContext().createGain();this._gainNode.connect(this.GetDestinationNode());this._pannerNode=null;this._isPannerEnabled=!1;this._pannerPosition=[0,0,0];this._pannerOrientation=[0,0,0];this._isStopped=!0;this._isLooping=this._resumeMe=this._isPaused=!1;this._volume=1;this._isMuted=!1;this._playbackRate=1;a=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=
1===a&&!this.IsMusic()||2===a;this._fadeEndTime=this._instUid=-1;this._stopOnFadeEnd=!1}Release(){this._buffer=this._audioDomHandler=null;this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null);this._gainNode.disconnect();this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this._tag)}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/
1E3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}SetTag(a){this._tag=a}GetTag(){return this._tag}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(a){let b=this._buffer.GetDuration();
a&&(b/=this._playbackRate||.001);return b}Play(a,b,d,l){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(a){this._volume=a;this._gainNode.gain.cancelScheduledValues(0);this._fadeEndTime=-1;this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(a,b,d){if(!this.IsMuted()){var l=this._gainNode.gain;l.cancelScheduledValues(0);var w=this._audioDomHandler.GetAudioCurrentTime();b=w+b;l.setValueAtTime(l.value,w);l.linearRampToValueAtTime(a,b);this._volume=a;this._fadeEndTime=b;
this._stopOnFadeEnd=d}}_UpdateVolume(){this.SetVolume(this._volume)}Tick(a){-1!==this._fadeEndTime&&a>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tag,this._aiId))}GetOutputVolume(){const a=this._volume;return isFinite(a)?a:0}SetMuted(a){a=!!a;this._isMuted!==a&&(this._isMuted=a,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(a){}IsLooping(){return this._isLooping}SetPlaybackRate(a){this._playbackRate!==
a&&(this._playbackRate=a,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(a){}SetSuspended(a){}SetPannerEnabled(a){a=!!a;this._isPannerEnabled!==a&&((this._isPannerEnabled=a)?(this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),
this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(a,b,d,l,w,y){this._isPannerEnabled&&(this.SetPanXYA(a,b,d),a=self.AudioDOMHandler.ToDegrees,this._pannerNode.coneInnerAngle=
a(l),this._pannerNode.coneOuterAngle=a(w),this._pannerNode.coneOuterGain=y)}SetPanXYA(a,b,d){this._isPannerEnabled&&(this._pannerPosition[0]=a,this._pannerPosition[1]=b,this._pannerPosition[2]=0,this._pannerOrientation[0]=Math.cos(d),this._pannerOrientation[1]=Math.sin(d),this._pannerOrientation[2]=0,this._pannerNode.setPosition(...this._pannerPosition),this._pannerNode.setOrientation(...this._pannerOrientation))}SetUID(a){this._instUid=a}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(a){const b=
this._pannerNode||this._gainNode;b.disconnect();b.connect(a)}GetState(){return{aiid:this.GetAiId(),tag:this._tag,duration:this.GetDuration(),volume:this._volume,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState()}}_LoadAdditionalState(a){this.SetPlaybackRate(a.playbackRate);
this.SetMuted(a.isMuted)}GetPanState(){if(!this._pannerNode)return null;const a=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:a.coneInnerAngle,coa:a.coneOuterAngle,cog:a.coneOuterGain,uid:this._instUid}}LoadPanState(a){if(a){this.SetPannerEnabled(!0);a=this._pannerNode;var b=a.pos;this._pannerPosition[0]=b[0];this._pannerPosition[1]=b[1];this._pannerPosition[2]=b[2];b=a.orient;this._pannerOrientation[0]=b[0];this._pannerOrientation[1]=b[1];this._pannerOrientation[2]=
b[2];a.setPosition(...this._pannerPosition);a.setOrientation(...this._pannerOrientation);a.coneInnerAngle=a.cia;a.coneOuterAngle=a.coa;a.coneOuterGain=a.cog;this._instUid=a.uid}else this.SetPannerEnabled(!1)}}}"use strict";
self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(g,a,b){super(g,a,b);this._buffer.GetOutputNode().connect(this._gainNode);this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop();this._buffer.GetOutputNode().disconnect();super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0;this._instUid=-1;this._audioDomHandler.PostTrigger("ended",this._tag,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return this._isStopped?
!0:this.HasEnded()}GetPlaybackTime(){let g=this.GetAudioElement().currentTime;this._isLooping||(g=Math.min(g,this.GetDuration()));return g}Play(g,a,b,d){d=this.GetAudioElement();1!==d.playbackRate&&(d.playbackRate=1);d.loop!==g&&(d.loop=g);this.SetVolume(a);d.muted&&(d.muted=!1);if(d.currentTime!==b)try{d.currentTime=b}catch(l){console.warn(`[Construct 3] Exception seeking audio '${this._buffer.GetUrl()}' to position '${b}': `,l)}this._audioDomHandler.TryPlayMedia(d);this._isPaused=this._isStopped=
!1;this._isLooping=g;this._playbackRate=1}Stop(){const g=this.GetAudioElement();g.paused||g.pause();this._audioDomHandler.RemovePendingPlay(g);this._isStopped=!0;this._isPaused=!1;this._instUid=-1}Pause(){if(!(this._isPaused||this._isStopped||this.HasEnded())){var g=this.GetAudioElement();g.paused||g.pause();this._audioDomHandler.RemovePendingPlay(g);this._isPaused=!0}}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=
!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(g){g=!!g;this._isLooping!==g&&(this._isLooping=g,this.GetAudioElement().loop=g)}_UpdatePlaybackRate(){let g=this._playbackRate;this._isTimescaled&&(g*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=g}catch(a){console.warn(`[Construct 3] Unable to set playback rate '${g}':`,a)}}Seek(g){if(!this._isStopped&&!this.HasEnded())try{this.GetAudioElement().currentTime=g}catch(a){console.warn(`[Construct 3] Error seeking audio to '${g}': `,
a)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(g){g?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};"use strict";
self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(g,a,b){super(g,a,b);this._bufferSource=null;this._onended_handler=d=>this._OnEnded(d);this._hasPlaybackEnded=!0;this._activeSource=null;this._resumePosition=this._playFromSeekPos=this._playStartTime=0;this._muteVol=1}Release(){this.Stop();this._ReleaseBufferSource();this._onended_handler=null;super.Release()}_ReleaseBufferSource(){this._bufferSource&&this._bufferSource.disconnect();this._activeSource=this._bufferSource=null}_OnEnded(g){this._isPaused||
this._resumeMe||g.target!==this._activeSource||(this._isStopped=this._hasPlaybackEnded=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tag,this._aiId))}HasEnded(){return!this._isStopped&&this._bufferSource&&this._bufferSource.loop||this._isPaused?!1:this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let g;g=this._isPaused?this._resumePosition:this._playFromSeekPos+(this.GetCurrentTime()-
this._playStartTime)*this._playbackRate;this._isLooping||(g=Math.min(g,this.GetDuration()));return g}Play(g,a,b,d){this._muteVol=1;this.SetVolume(a);this._ReleaseBufferSource();this._bufferSource=this.GetAudioContext().createBufferSource();this._bufferSource.buffer=this._buffer.GetAudioBuffer();this._bufferSource.connect(this._gainNode);this._activeSource=this._bufferSource;this._bufferSource.onended=this._onended_handler;this._bufferSource.loop=g;this._bufferSource.start(d,b);this._isPaused=this._isStopped=
this._hasPlaybackEnded=!1;this._isLooping=g;this._playbackRate=1;this._playStartTime=this.GetCurrentTime();this._playFromSeekPos=b}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch(g){}this._isStopped=!0;this._isPaused=!1;this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||
this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,
this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1;this._UpdateVolume()}SetLooping(g){g=!!g;this._isLooping!==g&&(this._isLooping=g,this._bufferSource&&(this._bufferSource.loop=g))}_UpdatePlaybackRate(){let g=this._playbackRate;this._isTimescaled&&(g*=this._audioDomHandler.GetTimeScale());this._bufferSource&&(this._bufferSource.playbackRate.value=g)}Seek(g){this._isStopped||this.HasEnded()||(this._isPaused?
this._resumePosition=g:(this.Pause(),this._resumePosition=g,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(g){g?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),
this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(g){super._LoadAdditionalState(g);this._resumePosition=g.resumePosition}};"use strict";
{class g{constructor(a){this._audioDomHandler=a;this._audioContext=a.GetAudioContext();this._index=-1;this._type=this._tag="";this._params=null}Release(){this._audioContext=null}_SetIndex(a){this._index=a}GetIndex(){return this._index}_SetTag(a){this._tag=a}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(a){}SetAudioParam(a,b,d,l){a.cancelScheduledValues(0);if(0===l)a.value=b;else{var w=this._audioContext.currentTime;l+=w;switch(d){case 0:a.setValueAtTime(b,
l);break;case 1:a.setValueAtTime(a.value,w);a.linearRampToValueAtTime(b,l);break;case 2:a.setValueAtTime(a.value,w),a.exponentialRampToValueAtTime(b,l)}}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends g{constructor(a,b,d,l,w,y,n){super(a);this._type="filter";this._params=[b,d,l,w,y,n];this._inputNode=this.CreateGain();this._wetNode=this.CreateGain();this._wetNode.gain.value=n;this._dryNode=this.CreateGain();this._dryNode.gain.value=1-n;this._filterNode=
this._audioContext.createBiquadFilter();this._filterNode.type=b;this._filterNode.frequency.value=d;this._filterNode.detune.value=l;this._filterNode.Q.value=w;this._filterNode.gain.vlaue=y;this._inputNode.connect(this._filterNode);this._inputNode.connect(this._dryNode);this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect();this._filterNode.disconnect();this._wetNode.disconnect();this._dryNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();this._wetNode.connect(a);
this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[5]=b;this.SetAudioParam(this._wetNode.gain,b,d,l);this.SetAudioParam(this._dryNode.gain,1-b,d,l);break;case 1:this._params[1]=b;this.SetAudioParam(this._filterNode.frequency,b,d,l);break;case 2:this._params[2]=b;this.SetAudioParam(this._filterNode.detune,b,d,l);break;case 3:this._params[3]=b;this.SetAudioParam(this._filterNode.Q,
b,d,l);break;case 4:this._params[4]=b,this.SetAudioParam(this._filterNode.gain,b,d,l)}}};self.C3AudioDelayFX=class extends g{constructor(a,b,d,l){super(a);this._type="delay";this._params=[b,d,l];this._inputNode=this.CreateGain();this._wetNode=this.CreateGain();this._wetNode.gain.value=l;this._dryNode=this.CreateGain();this._dryNode.gain.value=1-l;this._mainNode=this.CreateGain();this._delayNode=this._audioContext.createDelay(b);this._delayNode.delayTime.value=b;this._delayGainNode=this.CreateGain();
this._delayGainNode.gain.value=d;this._inputNode.connect(this._mainNode);this._inputNode.connect(this._dryNode);this._mainNode.connect(this._wetNode);this._mainNode.connect(this._delayNode);this._delayNode.connect(this._delayGainNode);this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect();this._wetNode.disconnect();this._dryNode.disconnect();this._mainNode.disconnect();this._delayNode.disconnect();this._delayGainNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();
this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){const w=self.AudioDOMHandler.DbToLinear;switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[2]=b;this.SetAudioParam(this._wetNode.gain,b,d,l);this.SetAudioParam(this._dryNode.gain,1-b,d,l);break;case 4:this._params[1]=w(b);this.SetAudioParam(this._delayGainNode.gain,w(b),d,l);break;case 5:this._params[0]=b,this.SetAudioParam(this._delayNode.delayTime,b,d,l)}}};
self.C3AudioConvolveFX=class extends g{constructor(a,b,d,l){super(a);this._type="convolution";this._params=[d,l];this._bufferType=this._bufferUrl=this._bufferOriginalUrl="";this._inputNode=this.CreateGain();this._wetNode=this.CreateGain();this._wetNode.gain.value=l;this._dryNode=this.CreateGain();this._dryNode.gain.value=1-l;this._convolveNode=this._audioContext.createConvolver();this._convolveNode.normalize=d;this._convolveNode.buffer=b;this._inputNode.connect(this._convolveNode);this._inputNode.connect(this._dryNode);
this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect();this._convolveNode.disconnect();this._wetNode.disconnect();this._dryNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0),this._params[1]=b,this.SetAudioParam(this._wetNode.gain,b,d,l),this.SetAudioParam(this._dryNode.gain,
1-b,d,l)}}_SetBufferInfo(a,b,d){this._bufferOriginalUrl=a;this._bufferUrl=b;this._bufferType=d}GetState(){const a=super.GetState();a.bufferOriginalUrl=this._bufferOriginalUrl;a.bufferUrl="";a.bufferType=this._bufferType;return a}};self.C3AudioFlangerFX=class extends g{constructor(a,b,d,l,w,y){super(a);this._type="flanger";this._params=[b,d,l,w,y];this._inputNode=this.CreateGain();this._dryNode=this.CreateGain();this._dryNode.gain.value=1-y/2;this._wetNode=this.CreateGain();this._wetNode.gain.value=
y/2;this._feedbackNode=this.CreateGain();this._feedbackNode.gain.value=w;this._delayNode=this._audioContext.createDelay(b+d);this._delayNode.delayTime.value=b;this._oscNode=this._audioContext.createOscillator();this._oscNode.frequency.value=l;this._oscGainNode=this.CreateGain();this._oscGainNode.gain.value=d;this._inputNode.connect(this._delayNode);this._inputNode.connect(this._dryNode);this._delayNode.connect(this._wetNode);this._delayNode.connect(this._feedbackNode);this._feedbackNode.connect(this._delayNode);
this._oscNode.connect(this._oscGainNode);this._oscGainNode.connect(this._delayNode.delayTime);this._oscNode.start(0)}Release(){this._oscNode.stop(0);this._inputNode.disconnect();this._delayNode.disconnect();this._oscNode.disconnect();this._oscGainNode.disconnect();this._dryNode.disconnect();this._wetNode.disconnect();this._feedbackNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,
b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[4]=b;this.SetAudioParam(this._wetNode.gain,b/2,d,l);this.SetAudioParam(this._dryNode.gain,1-b/2,d,l);break;case 6:this._params[1]=b/1E3;this.SetAudioParam(this._oscGainNode.gain,b/1E3,d,l);break;case 7:this._params[2]=b;this.SetAudioParam(this._oscNode.frequency,b,d,l);break;case 8:this._params[3]=b/100,this.SetAudioParam(this._feedbackNode.gain,b/100,d,l)}}};self.C3AudioPhaserFX=class extends g{constructor(a,b,d,l,w,y,n){super(a);
this._type="phaser";this._params=[b,d,l,w,y,n];this._inputNode=this.CreateGain();this._dryNode=this.CreateGain();this._dryNode.gain.value=1-n/2;this._wetNode=this.CreateGain();this._wetNode.gain.value=n/2;this._filterNode=this._audioContext.createBiquadFilter();this._filterNode.type="allpass";this._filterNode.frequency.value=b;this._filterNode.detune.value=d;this._filterNode.Q.value=l;this._oscNode=this._audioContext.createOscillator();this._oscNode.frequency.value=y;this._oscGainNode=this.CreateGain();
this._oscGainNode.gain.value=w;this._inputNode.connect(this._filterNode);this._inputNode.connect(this._dryNode);this._filterNode.connect(this._wetNode);this._oscNode.connect(this._oscGainNode);this._oscGainNode.connect(this._filterNode.frequency);this._oscNode.start(0)}Release(){this._oscNode.stop(0);this._inputNode.disconnect();this._filterNode.disconnect();this._oscNode.disconnect();this._oscGainNode.disconnect();this._dryNode.disconnect();this._wetNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();
this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[5]=b;this.SetAudioParam(this._wetNode.gain,b/2,d,l);this.SetAudioParam(this._dryNode.gain,1-b/2,d,l);break;case 1:this._params[0]=b;this.SetAudioParam(this._filterNode.frequency,b,d,l);break;case 2:this._params[1]=b;this.SetAudioParam(this._filterNode.detune,b,d,l);break;case 3:this._params[2]=b;this.SetAudioParam(this._filterNode.Q,
b,d,l);break;case 6:this._params[3]=b;this.SetAudioParam(this._oscGainNode.gain,b,d,l);break;case 7:this._params[4]=b,this.SetAudioParam(this._oscNode.frequency,b,d,l)}}};self.C3AudioGainFX=class extends g{constructor(a,b){super(a);this._type="gain";this._params=[b];this._node=this.CreateGain();this._node.gain.value=b}Release(){this._node.disconnect();super.Release()}ConnectTo(a){this._node.disconnect();this._node.connect(a)}GetInputNode(){return this._node}SetParam(a,b,d,l){const w=self.AudioDOMHandler.DbToLinear;
switch(a){case 4:this._params[0]=w(b),this.SetAudioParam(this._node.gain,w(b),d,l)}}};self.C3AudioTremoloFX=class extends g{constructor(a,b,d){super(a);this._type="tremolo";this._params=[b,d];this._node=this.CreateGain();this._node.gain.value=1-d/2;this._oscNode=this._audioContext.createOscillator();this._oscNode.frequency.value=b;this._oscGainNode=this.CreateGain();this._oscGainNode.gain.value=d/2;this._oscNode.connect(this._oscGainNode);this._oscGainNode.connect(this._node.gain);this._oscNode.start(0)}Release(){this._oscNode.stop(0);
this._oscNode.disconnect();this._oscGainNode.disconnect();this._node.disconnect();super.Release()}ConnectTo(a){this._node.disconnect();this._node.connect(a)}GetInputNode(){return this._node}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[1]=b;this.SetAudioParam(this._node.gain,1-b/2,d,l);this.SetAudioParam(this._oscGainNode.gain,b/2,d,l);break;case 7:this._params[0]=b,this.SetAudioParam(this._oscNode.frequency,b,d,l)}}};self.C3AudioRingModFX=class extends g{constructor(a,
b,d){super(a);this._type="ringmod";this._params=[b,d];this._inputNode=this.CreateGain();this._wetNode=this.CreateGain();this._wetNode.gain.value=d;this._dryNode=this.CreateGain();this._dryNode.gain.value=1-d;this._ringNode=this.CreateGain();this._ringNode.gain.value=0;this._oscNode=this._audioContext.createOscillator();this._oscNode.frequency.value=b;this._oscNode.connect(this._ringNode.gain);this._oscNode.start(0);this._inputNode.connect(this._ringNode);this._inputNode.connect(this._dryNode);this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0);
this._oscNode.disconnect();this._ringNode.disconnect();this._inputNode.disconnect();this._wetNode.disconnect();this._dryNode.disconnect();super.Release()}ConnectTo(a){this._wetNode.disconnect();this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/100,1),0);this._params[1]=b;this.SetAudioParam(this._wetNode.gain,b,d,l);this.SetAudioParam(this._dryNode.gain,1-b,d,l);break;case 7:this._params[0]=
b,this.SetAudioParam(this._oscNode.frequency,b,d,l)}}};self.C3AudioDistortionFX=class extends g{constructor(a,b,d,l,w,y){super(a);this._type="distortion";this._params=[b,d,l,w,y];this._inputNode=this.CreateGain();this._preGain=this.CreateGain();this._postGain=this.CreateGain();this._SetDrive(l,w);this._wetNode=this.CreateGain();this._wetNode.gain.value=y;this._dryNode=this.CreateGain();this._dryNode.gain.value=1-y;this._waveShaper=this._audioContext.createWaveShaper();this._curve=new Float32Array(65536);
this._GenerateColortouchCurve(b,d);this._waveShaper.curve=this._curve;this._inputNode.connect(this._preGain);this._inputNode.connect(this._dryNode);this._preGain.connect(this._waveShaper);this._waveShaper.connect(this._postGain);this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect();this._preGain.disconnect();this._waveShaper.disconnect();this._postGain.disconnect();this._wetNode.disconnect();this._dryNode.disconnect();super.Release()}_SetDrive(a,b){.01>a&&(a=.01);this._preGain.gain.value=
a;this._postGain.gain.value=Math.pow(1/a,.6)*b}_GenerateColortouchCurve(a,b){for(let d=0;32768>d;++d){let l=d/32768;l=this._Shape(l,a,b);this._curve[32768+d]=l;this._curve[32768-d-1]=-l}}_Shape(a,b,d){d=1.05*d*b-b;const l=0>a?-1:1;a=0>a?-a:a;return(a<b?a:b+d*self.AudioDOMHandler.e4(a-b,1/d))*l}ConnectTo(a){this._wetNode.disconnect();this._wetNode.connect(a);this._dryNode.disconnect();this._dryNode.connect(a)}GetInputNode(){return this._inputNode}SetParam(a,b,d,l){switch(a){case 0:b=Math.max(Math.min(b/
100,1),0),this._params[4]=b,this.SetAudioParam(this._wetNode.gain,b,d,l),this.SetAudioParam(this._dryNode.gain,1-b,d,l)}}};self.C3AudioCompressorFX=class extends g{constructor(a,b,d,l,w,y){super(a);this._type="compressor";this._params=[b,d,l,w,y];this._node=this._audioContext.createDynamicsCompressor();this._node.threshold.value=b;this._node.knee.value=d;this._node.ratio.value=l;this._node.attack.value=w;this._node.release.value=y}Release(){this._node.disconnect();super.Release()}ConnectTo(a){this._node.disconnect();
this._node.connect(a)}GetInputNode(){return this._node}SetParam(a,b,d,l){}};self.C3AudioAnalyserFX=class extends g{constructor(a,b,d){super(a);this._type="analyser";this._params=[b,d];this._node=this._audioContext.createAnalyser();this._node.fftSize=b;this._node.smoothingTimeConstant=d;this._freqBins=new Float32Array(this._node.frequencyBinCount);this._signal=new Uint8Array(b);this._rms=this._peak=0;this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this);this._node.disconnect();
super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins);this._node.getByteTimeDomainData(this._signal);const a=this._node.fftSize;let b=this._peak=0;for(var d=0;d<a;++d){let l=(this._signal[d]-128)/128;0>l&&(l=-l);this._peak<l&&(this._peak=l);b+=l*l}d=self.AudioDOMHandler.LinearToDb;this._peak=d(this._peak);this._rms=d(Math.sqrt(b/a))}ConnectTo(a){this._node.disconnect();this._node.connect(a)}GetInputNode(){return this._node}SetParam(a,b,d,l){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),
peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}"use strict";
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(g){super(g,"mouse");this.AddRuntimeMessageHandlers([["cursor",a=>this._OnChangeCursorStyle(a)],["request-pointer-lock",()=>this._OnRequestPointerLock()],["release-pointer-lock",()=>this._OnReleasePointerLock()]]);document.addEventListener("pointerlockchange",a=>this._OnPointerLockChange());document.addEventListener("pointerlockerror",a=>this._OnPointerLockError())}_OnChangeCursorStyle(g){document.documentElement.style.cursor=
g}_OnRequestPointerLock(){this._iRuntime.GetCanvas().requestPointerLock()}_OnReleasePointerLock(){document.exitPointerLock()}_OnPointerLockChange(){this.PostToRuntime("pointer-lock-change",{"has-pointer-lock":!!document.pointerLockElement})}_OnPointerLockError(){this.PostToRuntime("pointer-lock-error",{"has-pointer-lock":!!document.pointerLockElement})}});"use strict";
{const g=[],a=2*Math.PI;function b(k){k%=a;0>k&&(k+=a);return k}function d(k,t,v){return k<t?t:k>v?v:k}function l(k,t,v){return k+v*(t-k)}function w(k,t,v){return k===t?0:(v-k)/(t-k)}function y(k,t){if(k===t)return 0;k=Math.sin(k)*Math.sin(t)+Math.cos(k)*Math.cos(t);return 1<=k?0:-1>=k?Math.PI:Math.acos(k)}function n(k,t){return 0>=Math.cos(k)*Math.sin(t)-Math.sin(k)*Math.cos(t)}function r(k,t,v){const A=y(k,t);return n(t,k)?b(k+A*v):b(k-A*v)}class c{constructor(k,t,v,A,B,F){this._index=k;this._interp=
t;this._precision=v;this._tag=A;this._userData=B;this._clientValueTag=F}GetRuntimeData(){return{tag:this._tag,interp:this._interp,userData:this._userData,cvt:this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!==typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(k){switch(this._precision){case 0:return k;case 1:return Math.fround(k);
case 2:return 2===this._interp&&(k=b(k),k/=Math.PI,k=32767*(k-1)),d(k|0,-32768,32767);case 3:return 2===this._interp&&(k=b(k),k/=a,k*=255),d(k|0,0,255);default:return k}}Write(k,t,v){switch(this._precision){case 0:k.setFloat64(t,v);t+=8;break;case 1:k.setFloat32(t,v);t+=4;break;case 2:k.setInt16(t,v);t+=2;break;case 3:k.setUint8(t,v);t+=1;break;default:k.setFloat32(t,v),t+=4}return t}MaybeUnpack(k){if(2!==this._interp)return k;2===this._precision?k=(k/32767+1)*Math.PI:3===this._precision&&(k=k/255*
a);return k}static InterpNetValue(k,t,v,A,B){switch(k){case 0:return B?v:t;case 1:return l(t,v,A);case 2:return r(t,v,A);default:return B?v:t}}}class e{constructor(k,t){this.timestamp=k;this.data=t}}class p{constructor(k,t,v){this._ro=k;this._domHandler=k.GetDOMHandler();this._id=t;this._nid=v;this._data=[];this._data.length=this._ro.GetNetValues().length;this._lastTransmitted=this._lastChanged=0;this._isAlive=this._transmitMe=!1;this._updates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=
null}GetRuntimeData(){var k=[];for(let v=0,A=this._ro.GetNetValues().length;v<A;++v)k.push(this.GetInterp(this._ro.GetSimTime(),v));k={id:this._id,nid:this._nid,isTimedOut:this.IsTimedOut(),interpValues:k,latestUpdate:null};const t=this.GetLatestUpdate();t&&(k.latestUpdate={timestamp:t.timestamp,data:t.data});return k}GetId(){return this._id}GetNid(){return this._nid}SetAlive(k){this._isAlive=!!k}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(k,t){k=k.netValues;
var v=this._ro.GetNetValues();const A=v.length;this._transmitMe=!1;for(let B=0;B<A;++B){const F=v[B].Clamp(k[B]);this._data[B]!==F&&(this._data[B]=F,this._lastChanged=t,this._ro.SetLastChanged(t))}k=t-this._lastChanged;t-=this._lastTransmitted;v=this._ro.GetBandwidth();(this._transmitMe=100>k&&0===v?!0:1E3>k&&1>=v?95<=t:495<=t)&&this._ro.IncNumberToTransmit()}WriteData(k,t,v){const A=this._ro.GetNetValues();this._lastTransmitted=v;k.setUint16(t,this._nid);t+=2;for(let B=0,F=this._data.length;B<F;++B)t=
A[B].Write(k,t,this._data[B]);return t}AddUpdate(k,t){for(let v=0,A=this._updates.length;v<A;++v){const B=this._updates[v];if(B.timestamp===k)return;if(B.timestamp>k){this._updates.splice(v,0,new e(k,t));return}}this._updates.push(new e(k,t))}IsTimedOut(){return 0===this._updates.length?!1:this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3E3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();
const k=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>k&&this._priorUpdate&&this._priorUpdate.timestamp<k)){this._nextUpdate=null;for(let t=0,v=this._updates.length;t<v;++t){const A=this._updates[t];if(A.timestamp<=k){if(!this._priorUpdate||A.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,this._priorUpdate=A}else{this._nextUpdate=A;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(k,
t,v){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[t];const A=this._ro.GetNetValues();let B,F,H;if(!this._nextUpdate&&this._priorUpdate)return this._priorUpdate2&&!v?(B=this._priorUpdate2.timestamp,v=this._priorUpdate2.data[t],F=this._priorUpdate.timestamp,H=this._priorUpdate.data[t],k>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(k=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),k=w(B,F,k),c.InterpNetValue(A[t].GetInterp(),
v,H,k,!0)):this._priorUpdate.data[t];B=this._priorUpdate.timestamp;v=this._priorUpdate.data[t];F=this._nextUpdate.timestamp;H=this._nextUpdate.data[t];k=w(B,F,k);return c.InterpNetValue(A[t].GetInterp(),v,H,k,!1)}}class x{constructor(k,t,v,A){this._domHandler=k;this._roId=t;this._sid=v;this._nid=this._domHandler.GetNextObjectNid();this._bandwidth=A;this._userData={};this._instanceByteSize=0;this._extrapolateLimit=250;switch(this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=
2500}this._netValues=[];this._netInstances=[];this._idToNetInst=new Map;this._usedNids=new Set;this._numberToTransmit=this._lastTransmitted=this._lastChanged=this._nextNid=0;this._hasOverriddenNids=!1;this._deadNids=[];this._overrideNids=new Map;this._nidToNetInst=new Map;this._simTime=0;this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(k){this._nid=k}GetNid(){return this._nid}SetLastChanged(k){this._lastChanged=
k}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(k){this._hasOverriddenNids=!!k}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(k,t,v,A,B){k=new c(this._netValues.length,k,t,v,A,B);switch(t){case 0:this._instanceByteSize+=8;break;
case 1:this._instanceByteSize+=4;break;case 2:this._instanceByteSize+=2;break;case 3:this._instanceByteSize+=1}this._netValues.push(k)}AddUpdate(k,t,v){this.GetNetInstForNid(t).AddUpdate(k,v)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const k of this._netInstances)k.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(k){k=Math.floor(k);return 0>k||k>=this._netInstances.length?null:this._netInstances[k]}GetNetInstByNid(k){for(const t of this._netInstances)if(t.GetNid()===
k)return t;return null}GetNetValuesJson(){const k=[];for(const t of this._netValues){const v={tag:t.GetTag(),precision:t.GetPrecision(),interp:t.GetInterp(),clientvaluetag:t.GetClientValueTag()};t.HasUserData()&&(v.userdata=t.GetUserData());k.push(v)}return k}SetNetValuesFrom(k){this._instanceByteSize=this._netValues.length=0;for(const t of k)this.AddValue(t.interp,t.precision,t.tag,t.userdata,t.clientvaluetag)}GetNetInstForNid(k){let t=this._nidToNetInst.get(k);if(t)return t;t=new p(this,-1,k);this._nidToNetInst.set(k,
t);this._netInstances.push(t);return t}GetNetInstForId(k){let t=this._idToNetInst.get(k);if(t)return t;t=new p(this,k,this.AllocateInstanceNid());this._idToNetInst.set(k,t);this._netInstances.push(t);return t}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const k=this._nextNid;this._usedNids.add(k);return k}RemoveNetInstance(k){const t=k.GetId(),v=k.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(v);
this._idToNetInst.delete(t);this._nidToNetInst.delete(v);this._usedNids.delete(v);k=this._netInstances.indexOf(k);-1<k&&this._netInstances.splice(k,1)}ClearAllNetInstances(){this._deadNids.length=0;this._idToNetInst.clear();this._nidToNetInst.clear();this._usedNids.clear();this._netInstances.length=0}UpdateData(k,t){this._numberToTransmit=0;for(var v of this._netInstances)v.SetAlive(!1);for(let A=0,B=k.length;A<B;++A){v=k[A];const F=this.GetNetInstForId(v.uid);F.SetAlive(!0);F.UpdateData(v,t)}for(const A of this._netInstances)A.IsAlive()||
g.push(A);for(const A of g)this.RemoveNetInstance(A);g.length=0}WriteData(k,t,v){k.setUint16(t,this._nid);t+=2;let A=0;this._hasOverriddenNids&&(A=1);k.setUint8(t,A);t+=1;k.setUint16(t,this._numberToTransmit);t+=2;k.setUint16(t,this._instanceByteSize);t+=2;for(const B of this._netInstances)B.ShouldTransmit()&&(t=B.WriteData(k,t,v));return t}OverrideNid(k,t){if(this._idToNetInst.has(k))console.warn("OverrideNid passed id "+k+" which is already in use and cannot be overridden");else if(this._usedNids.has(t))console.warn("OverrideNid passed nid "+
t+" which is already in use and cannot be overridden");else{var v=new p(this,k,t);this._idToNetInst.set(k,v);this._usedNids.add(t);this._netInstances.push(v);this._hasOverriddenNids=!0;return v}}RemoveObjectId(k){(k=this._idToNetInst.get(k))&&this.RemoveNetInstance(k)}RemoveObjectNid(k){(k=this._nidToNetInst.get(k))&&this.RemoveNetInstance(k)}GetRuntimeData(){return{hasOverriddenNids:this.HasOverriddenNids(),netValues:this._netValues.map(k=>k.GetRuntimeData()),netInstances:this._netInstances.map(k=>
k.GetRuntimeData())}}GetRuntimeInfoRequest(){return{roId:this._roId,sid:this._sid,netValues:this._netValues.map(k=>k.GetRuntimeData())}}}self.C3NetValue=c;self.C3NetUpdate=e;self.C3RegisteredObject=x}"use strict";
{const g=self.C3NetUpdate,a=self.C3NetValue,b=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection;function d(n){if(n)try{n.close()}catch(r){}}const l=[];function w(n,r,c){return n===r?0:(c-n)/(r-n)}class y{constructor(n,r,c){this._domHandler=n;this._id=r;this._nid=0;this._alias=c;this._dco=this._pc=null;this._isOOpen=!1;this._dcr=null;this._isROpen=!1;this._dcu=null;this._hasConfirmed=this._wasRemoved=this._firedClose=this._firedOpen=this._isUOpen=
!1;this._errorCount=this._connectTime=this._lastHeardFrom=0;this._localClientState=[];this._lastStateTransmit=this._lastStateChange=0;this._clientStateUpdates=[];this._nextUpdate=this._priorUpdate=this._priorUpdate2=null;this._lastPingSent=0;this._awaitingPong=!1;this._lastSentPingId=1;this._lastPingTimes=[];this._pdv=this._latency=0;this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(n){this._nid=n}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===
this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(n){this._lastStateChange=n}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(n){this._lastStateTransmit=n}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(n,r){n.binaryType="arraybuffer";n.onopen=()=>{"o"===r?this._isOOpen=!0:"r"===r?this._isROpen=!0:"u"===r&&(this._isUOpen=!0);this._MaybeFireOpen()};
n.onmessage=c=>{this._OnMessage(r,c)};n.onerror=c=>{console.error("Peer '"+this._id+"' datachannel '"+r+"' error: ",c);this._domHandler._OnPeerError(this,c);this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")};n.onclose=()=>{this.Remove("disconnect")}}Connect(){if(!this.IsSelf()){var n=this._domHandler.IsHost();this._firedClose=this._firedOpen=this._isUOpen=this._isROpen=this._isOOpen=!1;this._connectTime=performance.now();this._pc=new b({iceServers:this._domHandler.GetICEServerList()});
this._pc.onicecandidate=c=>{c.candidate&&this._domHandler.SignallingSend({message:"icecandidate",toclientid:this._id,icecandidate:c.candidate})};this._pc.onsignalingstatechange=()=>{this._pc&&"closed"===this._pc.signalingState&&this.Remove("disconnect")};this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))};this._pc.onconnectionstatechange=()=>{if(this._pc){var c=this._pc.connectionState;"failed"!==
c&&"closed"!==c||this.Remove("disconnect")}};var r=`c2mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;n?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:r}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:r}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,
maxRetransmits:0,protocol:r}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(c=>{this._pc.setLocalDescription(c);this._domHandler.SignallingSend({message:"offer",toclientid:this._id,offer:c})}).catch(c=>{console.error("Host error creating offer for peer '"+this._id+"': ",c);this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=c=>{if(c.channel.protocol!==r)console.error("Unexpected datachannel protocol '"+c.channel.protocol+"', should be '"+
r+"'"),this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+c.channel.protocol+"', should be '"+r+"'");else{var e=c.channel.label;"o"===e?this._dco=c.channel:"r"===e?this._dcr=c.channel:"u"===e?this._dcu=c.channel:(console.error("Unknown datachannel label: "+c.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+c.channel.label+"'"));this._AttachDataChannelHandlers(c.channel,e)}}}}async _AddICECandidate(n){if(this._pc)try{await this._pc.addIceCandidate(n)}catch(r){console.warn("[Multiplayer] Error adding ICE candidate: ",
r)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){!this._firedOpen&&this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){this._lastHeardFrom=performance.now();if(this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({c:"j",i:this._id,n:this._nid,a:this._alias}),this);this.Send("o",JSON.stringify({c:"hi",hn:this._domHandler.GetHostPeer().GetNid(),n:this._nid,d:this._domHandler.GetClientDelay(),
u:this._domHandler.GetPeerUpdateRateSec(),objs:this._domHandler.GetRegisteredObjectsMap(),cvs:this._domHandler.GetClientValuesJson()}));for(const n of this._domHandler.peers())!n.IsHost()&&n!==this&&n.IsOpen()&&this.Send("o",JSON.stringify({c:"j",i:n.GetId(),n:n.GetNid(),a:n.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0);this._domHandler._OnPeerOpen(this)}_MaybeFireClose(n){!this._firedClose&&this._firedOpen&&(this._OnClose(n),this._firedClose=!0,this._firedOpen=
!1)}_OnClose(n){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({c:"l",i:this._id,a:this._alias,r:n}),this);this.IsSelf()||this._domHandler._OnPeerClose(this,n)}IsOpen(){return this._firedOpen&&!this._firedClose}Send(n,r){this._domHandler.StatIncOutboundCount();var c=0;r.length?c=r.length:r.byteLength&&(c=r.byteLength);this._domHandler.StatAddOutboundBandwidthCount(c);c=this._domHandler.GetSimulatedPacketLoss();const e=this._domHandler.GetSimulatedLatency(),
p=this._domHandler.GetSimulatedPdv();if(!(0<c&&"u"===n&&Math.random()<c))if(0===e&&0===p)this._DoSend(n,r);else{let x=1;"u"!==n&&Math.random()<c&&(x=3);setTimeout(()=>this._DoSend(n,r),e*x+Math.random()*p*x)}}_DoSend(n,r){try{"o"===n?this._isOOpen&&this._dco&&this._dco.send(r):"r"===n?this._isROpen&&this._dcr&&this._dcr.send(r):"u"===n&&this._isUOpen&&this._dcu&&this._dcu.send(r)}catch(c){this._wasRemoved||(this._domHandler.IsHost()?"o"===n||"r"===n?("string"===typeof r?(console.error("Error sending "+
r.length+"-char string on '"+n+"' to '"+this._alias+"', host kicking: ",c),console.log("String that failed to send from previous error was: "+r)):console.error("Error sending "+(r.length||r.byteLength)+"-byte binary on '"+n+"' to '"+this._alias+"', host kicking: ",c),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"===typeof r?(console.error("Too many errors ("+this._errorCount+") sending data on '"+n+"' to '"+this._alias+"', kicking; last error was for sending "+r.length+
"-char string: ",c),console.log("String that failed to send from previous error was: "+r)):console.error("Too many errors ("+this._errorCount+") sending data on '"+n+"' to '"+this._alias+"', kicking; last error was for sending "+(r.length||r.byteLength)+"-byte binary: ",c),this.Remove("network error"))):console.error("Error sending data on '"+n+"': ",c))}}SendPing(n,r){this._wasRemoved||(!r&&!this.IsOpen()&&this._pc&&25E3<n-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),
this.Remove("timeout")):!r&&this.IsOpen()&&2E4<n-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),this.Remove("timeout")):(this._lastPingSent=n,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId)))}SendPong(n){n="pong:"+n.substr(5);this._domHandler.IsHost()&&(n=n+"/"+Math.round(performance.now()).toString());this.Send("u",n)}_OnPong(n){if(this._awaitingPong){var r=n.indexOf(":");if(-1<r){if(parseFloat(n.substr(r+1))===
this._lastSentPingId){r=performance.now();this._awaitingPong=!1;var c=(r-this._lastPingSent)/2;this._lastPingTimes.push(c);10<this._lastPingTimes.length&&this._lastPingTimes.shift();l.push(...this._lastPingTimes);l.sort((k,t)=>k-t);this._pdv=l[l.length-1]-l[0];var e=0,p=l.length;4<=l.length&&6>=l.length?(++e,--p):6<l.length&&(e+=2,p-=2);var x=0;for(let k=e;k<p;++k)x+=l[k];this._latency=x/(p-e);l.length=0;this._domHandler.IsHost()||(e=n.indexOf("/"),-1<e?(n=parseFloat(n.substr(e+1)),isFinite(n)?this._domHandler.AddHostTime(n,
r,c,this._latency):console.warn("Invalid host time from pong response")):console.warn("Cannot parse off host time from pong response"))}}else console.warn("Cannot parse off ping ID from pong")}}_OnMessage(n,r){const c=this._domHandler.GetSimulatedPacketLoss(),e=this._domHandler.GetSimulatedLatency(),p=this._domHandler.GetSimulatedPdv();if(!(0<c&&"u"===n&&Math.random()<c))if(0===e&&0===p)this._DoOnMessage(n,r);else{let x=1;"u"!==n&&Math.random()<c&&(x=3);setTimeout(()=>this._DoOnMessage(n,r),e*x+Math.random()*
p*x)}}_DoOnMessage(n,r){if(!this._wasRemoved){this._lastHeardFrom=performance.now();this._domHandler.StatIncInboundCount();var c=0;r.data.length?c=r.data.length:r.data.byteLength&&(c=r.data.byteLength);this._domHandler.StatAddInboundBandwidthCount(c);if("string"===typeof r.data){if(!(""===r.data.trim()||4>r.data.length))if(n=r.data.substr(0,4),"ping"===n)this.SendPong(r.data);else if("pong"===n)this._OnPong(r.data);else{try{var e=JSON.parse(r.data)}catch(p){this._domHandler._OnPeerError(this,p);this._domHandler.IsHost()?
(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",p),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",p);console.log("String that failed to parse from previous error: "+r.data);return}if(e)try{e.c&&"m"!==e.c?this._OnControlMessage(e):this._domHandler._OnPeerMessage(this,e)}catch(p){this._domHandler._OnPeerError(this,p),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",
p),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",p)}}}else{!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===n&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(r.data)}catch(p){this._domHandler._OnPeerError(this,p),this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",p),this.Remove("data error")):console.error("Error handling binary update for peer '"+
this._id+"': ",p)}}}}_OnControlMessage(n){switch(n.c){case "disconnect":n.k&&this._domHandler.PostToRuntime("peer-kicked");var r=!this._domHandler.IsHost()&&!this.IsHost();this.Remove(n.r);r&&this._domHandler.SignallingLeaveRoom();break;case "hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(n.hn),this._domHandler.GetSelfPeer()._SetNid(n.n),this._domHandler.SetClientDelay(n.d),this._domHandler.SetPeerUpdateRateSec(n.u),this._domHandler.MapObjectNids(n.objs),this._domHandler.MapClientValues(n.cvs));
break;case "j":this._domHandler.IsHost()||(r=new y(this._domHandler,n.i,n.a),r._SetNid(n.n),this._domHandler._OnPeerOpen(r));break;case "l":!this._domHandler.IsHost()&&(r=this._domHandler.GetPeerById(n.i))&&(r.IsSelf()||this._domHandler._OnPeerClose(r,n.r),r.Remove(n.r));break;default:console.error("Unknown control message from peer '"+this._id+"': "+n.c),this._domHandler._OnPeerError(this,"unknown control message '"+n.c+"'")}}_OnBinaryMessage(n){this._domHandler.IsHost()?this._OnHostUpdate(n):this._OnPeerUpdate(n)}_OnHostUpdate(n){n=
new DataView(n);let r=0;var c=n.getUint32(r);r+=4;if(1664249200!==c)console.warn("Rejected packet with incorrect magic number (received '"+c+"', expected '1664249200'");else if(c=n.getFloat64(r),r+=8,c+=this._latency,!(3E3<=Math.abs(c-performance.now()))){n.getUint8(r);r+=1;var e=n.getUint8(r);r+=1;var p=[],x=this._domHandler.GetClientValues();for(let t=0;t<e;++t)if(t>=x.length)p.push(0);else{var k=x[t];switch(k.GetPrecision()){case 0:k=n.getFloat64(r);r+=8;break;case 1:k=n.getFloat32(r);r+=4;break;
case 2:k=k.MaybeUnpack(n.getInt16(r));r+=2;break;case 3:k=k.MaybeUnpack(n.getUint8(r));r+=1;break;default:k=n.getFloat32(r),r+=4}p.push(k)}this._AddClientUpdate(c,p)}}_AddClientUpdate(n,r){for(let c=0,e=this._clientStateUpdates.length;c<e;++c){const p=this._clientStateUpdates[c];if(p.timestamp===n)return;if(p.timestamp>n){this._clientStateUpdates.splice(c,0,new g(n,r));return}}this._clientStateUpdates.push(new g(n,r))}Tick(n){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&
this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>n&&this._priorUpdate&&this._priorUpdate.timestamp<n)){this._nextUpdate=null;for(let r=0,c=this._clientStateUpdates.length;r<c;++r){const e=this._clientStateUpdates[r];if(e.timestamp<=n){if(!this._priorUpdate||e.timestamp>this._priorUpdate.timestamp)this._priorUpdate2=this._priorUpdate,
this._priorUpdate=e}else{this._nextUpdate=e;break}}}}}_OnPeerUpdate(n){n=new DataView(n);let r=0;var c=n.getUint32(r);r+=4;1664249200!==c?console.warn("Rejected packet with incorrect magic number (received '"+c+"', expected '1664249200'"):(c=n.getUint32(r),r+=4,0===c?this._HandlePeerUpdate(n,r):1===c?this._HandlePeerEvents(n,r):console.warn("Ignoring packet with incorrect flags (received "+c+", expected 0 or 1"))}_HandlePeerUpdate(n,r){const c=n.getFloat64(r);r+=8;const e=n.getUint16(r);r+=2;for(let t=
0;t<e;++t){var p=n.getUint16(r);r+=2;var x=n.getUint8(r);r+=1;let v=null,A=0;const B=this._domHandler.GetRegisteredObjectByNid(p);B?(v=B.GetNetValues(),A=v.length,1===x&&B._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+p);p=n.getUint16(r);r+=2;x=n.getUint16(r);r+=2;for(let F=0;F<p;++F){const H=n.getUint16(r);r+=2;if(B){const h=[];let m=r;for(let f=0;f<A;++f){var k=v[f];switch(k.GetPrecision()){case 0:k=n.getFloat64(m);m+=8;break;case 1:k=n.getFloat32(m);m+=4;
break;case 2:k=k.MaybeUnpack(n.getInt16(m));m+=2;break;case 3:k=k.MaybeUnpack(n.getUint8(m));m+=1;break;default:k=n.getFloat32(m),m+=4}h.push(k)}B.AddUpdate(c,H,h)}r+=x}}}_HandlePeerEvents(n,r){const c=n.getFloat64(r);r+=8;const e=n.getUint16(r);r+=2;for(let x=0;x<e;++x){var p=n.getUint16(r);r+=2;const k=this._domHandler.GetRegisteredObjectByNid(p);k||console.warn("Don't know which object corresponds to NID "+p);p=n.getUint16(r);r+=2;for(let t=0;t<p;++t){const v=n.getUint16(r);r+=2;k&&!k.HasOverriddenNids()&&
(this._domHandler._OnInstanceDestroyed(k,v,c),k.RemoveObjectNid(v))}}}Remove(n,r){if(!this._wasRemoved){this._wasRemoved=!0;this._MaybeFireClose(n);this.Send("o",JSON.stringify({c:"disconnect",r:n,k:!!r}));var c=this._dco,e=this._dcr,p=this._dcu,x=this._pc;setTimeout(()=>{d(c);d(e);d(p);d(x)},0);this._pc=this._dcu=this._dcr=this._dco=null;this._isUOpen=this._isROpen=this._isOOpen=!1;this._domHandler._RemovePeer(this)}}HasClientState(n){return this._domHandler.HasClientValueTag(n)}GetClientState(n){n=
this._domHandler.GetClientValueByTag(n);if(!n)return 0;n=n.GetIndex();if(0===this._clientStateUpdates.length)return 0;const r=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>n||n>=r.length?0:r[n]}GetInterpClientState(n){n=n.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){var r=this._nextUpdate.data;return 0>n||n>=r.length?0:r[n]}var c=this._domHandler.GetSimulationTime();let e,p;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2){var x=
this._priorUpdate2.timestamp;r=this._priorUpdate2.data[n];e=this._priorUpdate.timestamp;p=this._priorUpdate.data[n];c>this._priorUpdate.timestamp+250&&(c=this._priorUpdate.timestamp+250);x=w(x,e,c);return a.InterpNetValue(this._domHandler.GetClientValues()[n].GetInterp(),r,p,x,!0)}r=this._priorUpdate.data;return 0>n||n>=r.length?0:r[n]}x=this._priorUpdate.timestamp;r=this._priorUpdate.data[n];e=this._nextUpdate.timestamp;p=this._nextUpdate.data[n];x=w(x,e,c);return a.InterpNetValue(this._domHandler.GetClientValues()[n].GetInterp(),
r,p,x,!1)}}self.C3Peer=y}"use strict";
{const g=self.C3NetValue,a=self.C3Peer,b=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,d=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription,l=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate||window.msRTCIceCandidate,w=window.RTCDataChannel||window.webkitRTCDataChannel||window.mozRTCDataChannel||window.msRTCDataChannel,y=
[{urls:"stun:stun.l.google.com:19302"}];let n=!1;const r=[];self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(c){super(c,"multiplayer");this._iceServers=[];this._sigWs=null;this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""};this._room=this._gameInstance=this._game=this._myAlias=this._myId="";this._allPeers=[];this._peersById=new Map;this._nextPeerNid=0;this._usedPeerNids=new Set;this._hostPeer=
this._selfPeer=null;this._clientDelay=80;this._peerUpdateRateSec=this._hostUpdateRateSec=30;this._lastUpdateTime=0;this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundBandwidthCount:0};this._dataBuffer=new ArrayBuffer(262144);this._dataView=new DataView(this._dataBuffer);this._allRegisteredObjects=[];this._nextObjectNid=1;this._registeredObjectsByNid=new Map;this._registeredObjectsByRoId=
new Map;this._simPacketLoss=this._simPdv=this._simLatency=0;this._lastTimeDiffs=[];this._hostTimeDiff=this._targetHostTimeDiff=0;this._simDelay=this._targetSimDelay=this._clientDelay;this._allClientValues=[];this._clientValuesByTag=new Map;this._receivedClientValues=!1;this._MergeICEServerList(y);setInterval(()=>this._DoPings(),2E3);window.addEventListener("unload",()=>this.RemoveAllPeers("quit"));this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported());this.AddRuntimeMessageHandler("add-ice-servers",
e=>this._MergeICEServerList(e.list));this.AddRuntimeMessageHandler("simulate-latency",e=>this.SetLatencySimulation(e.latency,e.pdv,e.loss));this.AddRuntimeMessageHandler("set-bandwidth-profile",e=>this.SetBandwidthSettings(e.updateRate,e.delay));this.AddRuntimeMessageHandler("tick",e=>this.Tick(e));this.AddRuntimeMessageHandler("alert",e=>this.Alert(e));this.AddRuntimeMessageHandler("signalling-connect",e=>this.SignallingConnect(e.url));this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect());
this.AddRuntimeMessageHandler("signalling-login",e=>this.SignallingLogin(e.alias));this.AddRuntimeMessageHandler("signalling-join-room",e=>this.SignallingJoinGameRoom(e.game,e.instance,e.room,e.maxClients));this.AddRuntimeMessageHandler("signalling-auto-join-room",e=>this.SignallingAutoJoinGameRoom(e.game,e.instance,e.room,e.maxClients,e.lock));this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom());this.AddRuntimeMessageHandler("signalling-list-game-instances",e=>this.SignallingRequestGameInstanceList(e.game));
this.AddRuntimeMessageHandler("signalling-list-rooms",e=>this.SignallingRequestRoomList(e.game,e.instance,e.which));this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0));this.AddRuntimeMessageHandler("peer-send-message",e=>this.OnPeerSendMessage(e));this.AddRuntimeMessageHandler("host-broadcast",e=>this.OnHostBroadcast(e));this.AddRuntimeMessageHandler("kick-peer",e=>this.OnKickPeer(e));this.AddRuntimeMessageHandler("sync-object",e=>this.OnSyncObject(e));this.AddRuntimeMessageHandler("sync-inst-var",
e=>this.OnSyncInstVar(e));this.AddRuntimeMessageHandler("associate-object",e=>this.OnAssociateObject(e));this.AddRuntimeMessageHandler("remove-object-id",e=>this.RemoveObjectId(e.uid));this.AddRuntimeMessageHandler("remove-net-insts",e=>this.OnRemoveNetInsts(e));this.AddRuntimeMessageHandler("remove-object-nid",e=>this.OnRemoveObjectNid(e));this.AddRuntimeMessageHandler("set-client-state",e=>this.SetClientState(e.tag,e.value));this.AddRuntimeMessageHandler("add-client-input-value",e=>this.AddClientInputValue(e.tag,
e.precision,e.interp))}_GetErrorMessage(c){return c?"string"===typeof c?c:"string"===typeof c.message?c.message:"string"===typeof c.details?c.details:"string"===typeof c.data?c.data:"string"===typeof c.type?c.type:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return this.IsLoggedIn()&&this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this.IsLoggedIn()?
this._myId:""}GetMyAlias(){return this.IsLoggedIn()?this._myAlias:""}GetCurrentGame(){return this.IsLoggedIn()?this._game:""}GetCurrentGameInstance(){return this.IsLoggedIn()?this._gameInstance:""}GetCurrentRoom(){return this.IsInRoom()?this._room:""}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(c,e,p){this._simLatency=Math.max(c,
0);this._simPdv=Math.max(e,0);this._simPacketLoss=Math.max(p,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{isSupported:!(!b||!w)}}SignallingConnect(c){if(!this._sigWs&&!this._isSignallingConnected){try{this._sigWs=new WebSocket(c,"c2multiplayer")}catch(e){this._sigWs=null;this._OnSignallingError(e);return}this._sigWs.onopen=()=>{-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),
this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,this._isSignallingConnected=!1):this._isSignallingConnected=!0};this._sigWs.onclose=e=>{this._OnSignallingClose();this._isSignallingLoggedIn=this._isSignallingConnected=!1;this._sigWs=null};this._sigWs.onerror=e=>{console.error("Signalling server error: ",e);this._OnSignallingError(e)};this._sigWs.onmessage=e=>{this._OnSignallingMessage(e)}}}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),
this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(c){let e;try{e=JSON.parse(c.data)}catch(p){this._OnSignallingError(p);return}switch(e.message){case "welcome":this._OnSignallingReceiveWelcome(e);break;case "login-ok":this._OnSignallingReceiveLoginOK(e);break;case "join-ok":this._OnSignallingReceiveJoinOK(e);break;case "leave-ok":this._OnSignallingReceiveLeaveOK(e);break;case "kicked":this._OnSignallingReceiveKicked(e);break;case "peer-joined":this._OnSignallingReceivePeerJoined(e);
break;case "peer-quit":this._OnSignallingReceivePeerQuit(e);break;case "icecandidate":this._OnSignallingReceiveIceCandidate(e);break;case "offer":this._OnSignallingReceiveOffer(e);break;case "answer":this._OnSignallingReceiveAnswer(e);break;case "instance-list":this._OnSignallingReceiveInstanceList(e);break;case "room-list":this._OnSignallingReceiveRoomList(e);break;case "error":this._OnSignallingError(e.details);break;default:this._OnSignallingError("received unknown signalling message")}}HasICEServerUrl(c){for(const e of this._iceServers)if(e.urls===
c.urls)return!0;return!1}_MergeICEServerList(c){if(c)for(let e of c)"string"===typeof e&&(e={urls:e}),this.HasICEServerUrl(e)||(e.hasOwnProperty("url")||(e.url=e.urls),this._iceServers.push(e))}GetICEServerList(){return this._iceServers}_OnSignallingError(c){this.PostToRuntime("signalling-error",{message:this._GetErrorMessage(c)})}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(c){if(1>c.protocolrev||1<c.protocolrev)this._OnSignallingError("signalling server protocol revision not supported"),
this.SignallingDisconnect();else{this._myId=c.clientid;var e=this._sigservInfo;e.protocolrev=c.protocolrev;e.version=c.version;e.name=c.name;e.operator=c.operator;e.motd=c.motd;this._MergeICEServerList(c.ice_servers);this.PostToRuntime("signalling-welcome",{myid:this._myId,sigservinfo:{protocolrev:e.protocolrev,version:e.version,name:e.name,operator:e.operator,motd:e.motd}})}}_OnSignallingReceiveLoginOK(c){this._myAlias=c.alias;this._isSignallingLoggedIn=!0;this.PostToRuntime("signalling-login-ok",
{myalias:this._myAlias})}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));var c=this._nextPeerNid;this._usedPeerNids.add(c);return c}}FreePeerNid(c){this.IsHost()&&this._usedPeerNids.delete(c)}_OnSignallingReceiveJoinOK(c){this.RemoveAllPeers("disconnect");this._game=c.game;this._gameInstance=c.instance;this._room=c.room;this._selfPeer=new a(this,
this._myId,this._myAlias);c.host?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0,this._clientDelay=80,this._peerUpdateRateSec=this._hostUpdateRateSec=30,this._simDelay=this._targetSimDelay=this._clientDelay,this._hostPeer=new a(this,c.hostid,c.hostalias),this._hostPeer.Connect());this.PostToRuntime("signalling-join-ok",{isHost:!!c.host,hostId:this._hostPeer.GetId(),
hostAlias:this._hostPeer.GetAlias(),game:this._game,gameInstance:this._gameInstance,room:this._room})}_OnSignallingReceiveLeaveOK(c){this._room="";this.PostToRuntime("signalling-leave-ok")}_OnSignallingReceiveKicked(c){this.DisconnectRoom();this._room="";this.PostToRuntime("signalling-kicked")}_OnSignallingReceivePeerJoined(c){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var e=this._peersById.get(c.peerid);e&&e.Remove("rejoin");(new a(this,c.peerid,c.peeralias)).Connect()}}_OnSignallingReceivePeerQuit(c){if(this._isSignallingLoggedIn&&
this._room&&this.IsHost()){var e=this._peersById.get(c.id);e&&e.Remove(c.reason)}}_OnSignallingReceiveIceCandidate(c){if(this._isSignallingLoggedIn&&this._room){var e=this._peersById.get(c.from);e&&e._AddICECandidate(new l(c.icecandidate))}}_OnSignallingReceiveOffer(c){if(this._isSignallingLoggedIn&&this._room&&!this.IsHost()&&this._selfPeer&&this._hostPeer&&this._hostPeer.HasPeerConnection()&&c.from===this._hostPeer.GetId()){var e=this._hostPeer.GetPeerConnection();e.setRemoteDescription(new d(c.offer)).then(()=>
{e.createAnswer().then(p=>{e.setLocalDescription(p);this.SignallingSend({message:"answer",toclientid:this._hostPeer.GetId(),answer:p})}).catch(p=>{console.error("Peer error creating answer: ",p);this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(p=>{console.error("Peer error setting remote description: ",p);this._OnPeerError(this._selfPeer,"could not set remote description")})}}_OnSignallingReceiveAnswer(c){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){var e=
this._peersById.get(c.from);e&&e.GetPeerConnection().setRemoteDescription(new d(c.answer)).catch(p=>{console.error("Host error setting remote description: ",p)})}}_OnSignallingReceiveInstanceList(c){this.PostToRuntime("signalling-instance-list",{list:c.list})}_OnSignallingReceiveRoomList(c){this.PostToRuntime("signalling-room-list",{list:c.list})}SignallingSend(c){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(c))}SignallingLogin(c){this._isSignallingLoggedIn||this.SignallingSend({message:"login",
protocolrev:1,alias:c})}SignallingJoinGameRoom(c,e,p,x){this._isSignallingLoggedIn&&!this._room&&this.SignallingSend({message:"join",game:c,instance:e,room:p,max_clients:x})}SignallingAutoJoinGameRoom(c,e,p,x,k){this._isSignallingLoggedIn&&!this._room&&this.SignallingSend({message:"auto-join",game:c,instance:e,room:p,max_clients:x,lock_when_full:k})}SignallingLeaveRoom(){this._isSignallingLoggedIn&&this.SignallingSend({message:"leave"})}SignallingConfirmPeer(c){this._isSignallingLoggedIn&&this.IsHost()&&
this.SignallingSend({message:"confirm-peer",id:c})}SignallingRequestGameInstanceList(c){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-instances",game:c})}SignallingRequestRoomList(c,e,p){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-rooms",game:c,instance:e,which:p})}DisconnectRoom(c){this._hostTimeDiff=this._targetHostTimeDiff=this._lastTimeDiffs.length=0;this.RemoveAllPeers("disconnect");for(const e of this._allRegisteredObjects)e.ClearAllNetInstances();
c&&this.SignallingLeaveRoom()}_AddPeer(c){this._allPeers.push(c);this._peersById.set(c.GetId(),c);this.PostToRuntime("add-peer",{id:c.GetId(),alias:c.GetAlias()})}_RemovePeer(c){this.PostToRuntime("remove-peer",{id:c.GetId()});this.IsHost()&&this.FreePeerNid(c.GetNid());const e=this._allPeers.indexOf(c);-1<e&&this._allPeers.splice(e,1);this._peersById.delete(c.GetId());this._hostPeer===c&&(this._hostPeer=null,this.RemoveAllPeers("host quit"));this._selfPeer===c&&(this._selfPeer=null,this._room="",
this.RemoveAllPeers("disconnect"))}RemoveAllPeers(c){if(!n){for(n=!0;this._allPeers.length;)this._allPeers[0].Remove(c);n=!1}}GetPeerById(c){return this._peersById.get(c)||null}GetAliasFromId(c){return(c=this._peersById.get(c))?c.GetAlias():""}GetPeerByNid(c){for(const e of this._allPeers)if(e.GetNid()===c)return e;return null}OnHostBroadcast(c){const e=c.fromId,p=c.tag,x=c.message;c=c.mode;const k=this.GetPeerById(e);this.HostBroadcast(c,JSON.stringify({c:"m",t:p,f:e,m:x}),k)}HostBroadcast(c,e,p){if(this.IsHost()){var x=
this._allPeers.slice(0);for(const k of x)k&&k!==this._selfPeer&&k!==p&&k.Send(c,e)}}_DoPings(){const c=performance.now();if(this.IsHost()){r.push(...this._allPeers);for(const e of r)e&&e!==this._selfPeer&&e.SendPing(c,!1);r.length=0}else this._hostPeer&&this._hostPeer.SendPing(c,!1)}AddRegisteredObject(c){this._allRegisteredObjects.push(c);this._registeredObjectsByRoId.set(c.GetRoId(),c);this._registeredObjectsByNid.set(c.GetNid(),c)}GetRegisteredObjectsMap(){const c={};for(const [e,p]of this._registeredObjectsByNid.entries())c[p.GetSid()]=
{nid:e,nvs:p.GetNetValuesJson()};return c}MapObjectNids(c){this._registeredObjectsByNid.clear();for(const e of this._allRegisteredObjects)if(c.hasOwnProperty(e.GetSid().toString())){const p=c[e.GetSid().toString()];e._SetNid(p.nid);this._registeredObjectsByNid.set(p.nid,e);e.SetNetValuesFrom(p.nvs)}else console.warn("Could not map object SID '"+e.GetSid()+"' - host did not send NID for it"),e._SetNid(-1)}GetRegisteredObjectByNid(c){return this._registeredObjectsByNid.get(c)||null}Tick(c){if(!this.IsInRoom())return null;
c=c.dt;const e=performance.now();var p=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;e-this._lastUpdateTime>=1E3/p-5&&(this.SendUpdate(e),this._lastUpdateTime=e);p=this._stats;1E3<=e-p.lastSecondTime&&(p.outboundPerSec=p.outboundCount,p.outboundBandwidthPerSec=p.outboundBandwidthCount,p.inboundPerSec=p.inboundCount,p.inboundBandwidthPerSec=p.inboundBandwidthCount,p.outboundCount=0,p.outboundBandwidthCount=0,p.inboundCount=0,p.inboundBandwidthCount=0,p.lastSecondTime+=1E3,500<e-p.lastSecondTime&&
(p.lastSecondTime=e),this.PostToRuntime("stats",{stats:{outboundPerSec:p.outboundPerSec,outboundBandwidthPerSec:p.outboundBandwidthPerSec,inboundPerSec:p.inboundPerSec,inboundBandwidthPerSec:p.inboundBandwidthPerSec}}));this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*c,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*c,this._hostTimeDiff<this._targetHostTimeDiff&&
(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*c,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*c,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));c=this.GetSimulationTime();for(const x of this._allPeers)x.Tick(c);for(const x of this._allRegisteredObjects)x.Tick();return{simulationTime:this.GetSimulationTime(),hostInputArrivalTime:this.GetHostInputArrivalTime(),
clientDelay:this._clientDelay,peerData:this._GetPeerRuntimeData(),roData:this._GetRegisteredObjectRuntimeData(),isReadyForInput:this.IsReadyForInput()}}_GetPeerRuntimeData(){const c={};for(const e of this._allPeers){const p={};for(const x of this._allClientValues)p[x.GetTag()]=e.GetInterpClientState(x);c[e.GetId()]={nid:e.GetNid(),latency:e.GetLatency(),pdv:e.GetPdv(),clientState:p}}return c}_GetRegisteredObjectRuntimeData(){const c={};for(const e of this._allRegisteredObjects)c[e.GetRoId()]=e.GetRuntimeData();
return c}async SendUpdate(c){this.IsHost()?(await this._SendHostUpdate(c),this._SendHostEvents(c)):await this._SendClientUpdate(c)}async _OnBeforeClientUpdate(){const c=await this.PostToRuntimeAsync("before-client-update");for(const e of c.clientStateUpdates)this.SetClientState(e.tag,e.value)}async _SendClientUpdate(c){this.IsReadyForInput()&&await this._OnBeforeClientUpdate();if(this._selfPeer&&this._receivedClientValues){var e=this._dataView,p=0,x=this._allClientValues,k=this._selfPeer.GetLocalClientState(),
t=c-this._selfPeer.GetLastStateChange(),v=c-this._selfPeer.GetLastStateTransmit();if(100>t||(1E3>t?95<=v:495<=v)){e.setUint32(p,1664249200);p+=4;e.setFloat64(p,c+this._hostTimeDiff);p+=8;e.setUint8(p,0);p+=1;e.setUint8(p,x.length);p+=1;for(let A=0,B=x.length;A<B;++A)t=x[A],v=0,A<k.length&&(v=t.Clamp(k[A])),p=t.Write(e,p,v);this._selfPeer._SetLastStateTransmit(c);this._hostPeer.Send("u",new Uint8Array(this._dataBuffer.slice(0,p)))}}}async _SendHostUpdate(c){const e=this._dataView;let p=0,x=0;const k=
await this.PostToRuntimeAsync("get-object-info",{ros:this._allRegisteredObjects.map(t=>t.GetRuntimeInfoRequest())});for(const t of this._allRegisteredObjects){const v=t.GetRoId();k.hasOwnProperty(v)&&(t.UpdateData(k[v],c),0<t.GetNumberToTransmit()&&x++)}if(0!==x){e.setUint32(p,1664249200);p+=4;e.setUint32(p,0);p+=4;e.setFloat64(p,c);p+=8;e.setUint16(p,x);p+=2;for(const t of this._allRegisteredObjects)0<t.GetNumberToTransmit()&&(p=t.WriteData(e,p,c));this.HostBroadcast("u",new Uint8Array(this._dataBuffer.slice(0,
p)),null)}}_SendHostEvents(c){const e=this._dataView;let p=0,x=0;for(const k of this._allRegisteredObjects)k.GetDeadNids().length&&x++;if(0!==x){e.setUint32(p,1664249200);p+=4;e.setUint32(p,1);p+=4;e.setFloat64(p,c);p+=8;e.setUint16(p,x);p+=2;for(const k of this._allRegisteredObjects)if(c=k.GetDeadNids(),c.length){e.setUint16(p,k.GetNid());p+=2;e.setUint16(p,c.length);p+=2;for(const t of c)e.setUint16(p,t),p+=2;c.length=0}this.HostBroadcast("r",new Uint8Array(this._dataBuffer.slice(0,p)),null)}}AddHostTime(c,
e,p,x){if(!this.IsHost()){this._targetSimDelay=x+this._clientDelay;c=c+p-e;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=c,this._simDelay=this._targetSimDelay);this._lastTimeDiffs.push(c);30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift();r.push(...this._lastTimeDiffs);r.sort((k,t)=>k-t);c=0;e=r.length;4<=r.length&&6>=r.length?(++c,--e):6<r.length&&19>=r.length?(c+=2,e-=2):19<r.length&&(c+=5,e-=5);p=0;for(x=c;x<e;++x)p+=r[x];this._targetHostTimeDiff=p/(e-c);r.length=0}}GetSimulationTime(){return this.IsHost()?
performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(c,e){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues&&(c=this._clientValuesByTag.get(c))){c=c.GetIndex();var p=this._selfPeer.GetLocalClientState();p.length<c+1&&(p.length=c+1);
p[c]!==e&&(p[c]=e,this._selfPeer._SetLastStateChange(performance.now()))}}AddClientInputValue(c,e,p){e=new g(this._allClientValues.length,p,e,c,null);this._clientValuesByTag.set(c,e);this._allClientValues.push(e)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const c=[];for(const e of this._allClientValues)c.push({tag:e.GetTag(),precision:e.GetPrecision(),interp:e.GetInterp()});return c}MapClientValues(c){this._clientValuesByTag.clear();this._allClientValues.length=0;for(let p=
0,x=c.length;p<x;++p){var e=c[p];e=new g(p,e.interp,e.precision,e.tag,null);this._clientValuesByTag.set(e.GetTag(),e);this._allClientValues.push(e)}this._receivedClientValues=!0}RemoveObjectId(c){for(const e of this._allRegisteredObjects)e.RemoveObjectId(c)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(c){c=Math.floor(c);return!this.IsInRoom()||0>c||c>=this._allPeers.length?null:this._allPeers[c]}IsReadyForInput(){return this.IsInRoom()?this.IsHost()?
!0:0!==this._targetHostTimeDiff:!1}SetBandwidthSettings(c,e){this.IsInRoom()||(this._peerUpdateRateSec=this._hostUpdateRateSec=c,this._clientDelay=e)}_OnPeerOpen(c){this.PostToRuntime("peer-open",{id:c.GetId(),alias:c.GetAlias()})}OnPeerSendMessage(c){const e=c.tag,p=c.message,x=c.mode;(c=this.GetPeerById(c.id))&&c.Send(x,JSON.stringify({c:"m",t:e,m:p}))}_OnPeerClose(c,e){this.PostToRuntime("peer-close",{id:c.GetId(),alias:c.GetAlias(),reason:e||"unknown"})}_OnPeerError(c,e){console.error(`[Multiplayer] Peer '${c.GetAlias()}' (${c.GetId()}) error: `,
e)}_OnPeerMessage(c,e){c=e.f||c.GetId();this.PostToRuntime("peer-message",{tag:e.t,fromId:c,fromAlias:this.GetAliasFromId(c),content:e.m})}_OnInstanceDestroyed(c,e,p){this.PostToRuntime("instance-destroyed",{roId:c.GetRoId(),nid:e,timestamp:p})}OnKickPeer(c){if(this.IsHost()){var e=c.reason;(c=this.GetPeerById(c.id))&&c.Remove(e,!0)}}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(c){this._stats.outboundBandwidthCount+=c}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(c){this._stats.inboundBandwidthCount+=
c}SetClientDelay(c){this._clientDelay=c}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(c){this._peerUpdateRateSec=c}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(c){const e=c.data,p=c.precision,x=c.bandwidth;for(const k of c.objectClasses)c=new self.C3RegisteredObject(this,k.roId,k.sid,x),1===e?(c.AddValue(1,p,"x"),c.AddValue(1,p,"y")):2===e?c.AddValue(2,p,"a"):3===e&&(c.AddValue(1,p,"x"),c.AddValue(1,p,"y"),c.AddValue(2,p,"a"))}Alert(c){alert(c.message)}OnSyncInstVar(c){const e=
c.precision,p=c.interp,x=c.cvt;for(const k of c.syncData)this._registeredObjectsByRoId.get(k.roId).AddValue(p,e,"iv",k.varIndex,x)}OnAssociateObject(c){var e=c.peerId;const p=c.instUid;c=this._registeredObjectsByRoId.get(c.roId);e=this._peersById.get(e);c&&e&&this.IsHost()&&c.OverrideNid(p,e.GetNid())}OnRemoveNetInsts(c){for(const [e,p]of Object.entries(c))if(c=this._registeredObjectsByRoId.get(parseInt(e,10)))for(const x of p)c.RemoveObjectNid(x)}OnRemoveObjectNid(c){const e=c.nid;(c=this._registeredObjectsByRoId.get(c.roId))&&
c.RemoveObjectNid(e)}})}"use strict";
self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMHandler{constructor(g){super(g,"browser");this._exportType="";this.AddRuntimeMessageHandlers([["get-initial-state",a=>this._OnGetInitialState(a)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",a=>this._OnAlert(a)],["close",()=>this._OnClose()],["set-focus",a=>this._OnSetFocus(a)],["vibrate",a=>this._OnVibrate(a)],["lock-orientation",a=>this._OnLockOrientation(a)],["unlock-orientation",()=>this._OnUnlockOrientation()],
["navigate",a=>this._OnNavigate(a)],["request-fullscreen",a=>this._OnRequestFullscreen(a)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",a=>this._OnSetHash(a)]]);window.addEventListener("online",()=>this._OnOnlineStateChanged(!0));window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1));window.addEventListener("hashchange",()=>this._OnHashChange());document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}_OnGetInitialState(g){this._exportType=g.exportType;
return{location:location.toString(),isOnline:!!navigator.onLine,referrer:document.referrer,title:document.title,isCookieEnabled:!!navigator.cookieEnabled,screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,isConstructArcade:"undefined"!==typeof window.is_scirra_arcade}}_OnReadyForSWMessages(){window.C3_RegisterSW&&window.OfflineClientInfo&&window.OfflineClientInfo.SetMessageCallback(g=>this.PostToRuntime("sw-message",g.data))}_OnOnlineStateChanged(g){this.PostToRuntime("online-state",
{isOnline:g})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return"nwjs"===this._exportType?nw.Window.get():null}_OnAlert(g){alert(g.message)}_OnClose(){navigator.app&&navigator.app.exitApp?navigator.app.exitApp():navigator.device&&navigator.device.exitApp?navigator.device.exitApp():window.close()}_OnSetFocus(g){g=g.isFocus;if("nwjs"===this._exportType){const a=this.GetNWjsWindow();g?a.focus():a.blur()}else g?window.focus():window.blur()}_OnVibrate(g){navigator.vibrate&&
navigator.vibrate(g.pattern)}_OnLockOrientation(g){g=g.orientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(g).catch(a=>console.warn("[Construct 3] Failed to lock orientation: ",a));else try{let a=!1;screen.lockOrientation?a=screen.lockOrientation(g):screen.webkitLockOrientation?a=screen.webkitLockOrientation(g):screen.mozLockOrientation?a=screen.mozLockOrientation(g):screen.msLockOrientation&&(a=screen.msLockOrientation(g));a||console.warn("[Construct 3] Failed to lock orientation")}catch(a){console.warn("[Construct 3] Failed to lock orientation: ",
a)}}_OnUnlockOrientation(){try{screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.unlockOrientation?screen.unlockOrientation():screen.webkitUnlockOrientation?screen.webkitUnlockOrientation():screen.mozUnlockOrientation?screen.mozUnlockOrientation():screen.msUnlockOrientation&&screen.msUnlockOrientation()}catch(g){}}_OnNavigate(g){var a=g.type;if("back"===a)navigator.app&&navigator.app.backHistory?navigator.app.backHistory():window.history.back();else if("forward"===a)window.history.forward();
else if("reload"===a)location.reload();else if("url"===a){a=g.url;const b=g.target;g=g.exportType;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(a,"_system"):"preview"===g||"windows-webview2"===g?window.open(a,"_blank"):this._isConstructArcade||(2===b?window.top.location=a:1===b?window.parent.location=a:window.location=a)}else"new-window"===a&&(a=g.url,g=g.tag,self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(a,"_system"):window.open(a,g))}_OnRequestFullscreen(g){if("windows-webview2"===
this._exportType||"macos-wkwebview"===this._exportType)self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!0});else{const a={navigationUI:"auto"};g=g.navUI;1===g?a.navigationUI="hide":2===g&&(a.navigationUI="show");g=document.documentElement;g.requestFullscreen?g.requestFullscreen(a):g.mozRequestFullScreen?g.mozRequestFullScreen(a):g.msRequestFullscreen?g.msRequestFullscreen(a):g.webkitRequestFullScreen&&("undefined"!==typeof Element.ALLOW_KEYBOARD_INPUT?
g.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):g.webkitRequestFullScreen())}}_OnExitFullscreen(){"windows-webview2"===this._exportType||"macos-wkwebview"===this._exportType?(self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!1})):document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitCancelFullScreen&&
document.webkitCancelFullScreen()}_OnSetHash(g){location.hash=g.hash}_OnHashChange(){this.PostToRuntime("hashchange",{location:location.toString()})}});"use strict";
{function g(b){b.stopPropagation()}function a(b){13!==b.which&&27!==b.which&&b.stopPropagation()}self.RuntimeInterface.AddDOMHandlerClass(class extends self.DOMElementHandler{constructor(b){super(b,"text-input");this.AddDOMElementMessageHandler("scroll-to-bottom",d=>this._OnScrollToBottom(d))}CreateElement(b,d){let l;const w=d.type;"textarea"===w?(l=document.createElement("textarea"),l.style.resize="none"):(l=document.createElement("input"),l.type=w);l.style.position="absolute";l.autocomplete="off";
l.addEventListener("pointerdown",g);l.addEventListener("pointermove",g);l.addEventListener("pointerrawupdate",g);l.addEventListener("pointerup",g);l.addEventListener("mousedown",g);l.addEventListener("mouseup",g);l.addEventListener("keydown",a);l.addEventListener("keyup",a);l.addEventListener("click",y=>{y.stopPropagation();this._PostToRuntimeElementMaybeSync("click",b)});l.addEventListener("dblclick",y=>{y.stopPropagation();this._PostToRuntimeElementMaybeSync("dblclick",b)});l.addEventListener("input",
()=>this.PostToRuntimeElement("change",b,{text:l.value}));d.id&&(l.id=d.id);d.className&&(l.className=d.className);this.UpdateState(l,d);return l}UpdateState(b,d){b.value=d.text;b.placeholder=d.placeholder;b.title=d.title;b.disabled=!d.isEnabled;b.readOnly=d.isReadOnly;b.spellcheck=d.spellCheck;d=d.maxLength;0>d?b.removeAttribute("maxlength"):b.setAttribute("maxlength",d)}_OnScrollToBottom(b){b.scrollTop=b.scrollHeight}})};
